

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Advanced Data Analysis of a Retail Store using Apache Spark (PySpark) &#8212; Anindya&#39;s Blog</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous">
    <link href="../_static/css/index.css" rel="stylesheet">
    <link rel="stylesheet" href="../_static/sphinx-book-theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-dropdown.css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/sphinx-book-theme.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/sphinx-book-theme.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="5455. Minimum Number of Days to Make m Bouquets" href="../leetcode/lc5455.html" />
    <link rel="prev" title="Clustering Uber’s Trip Data with Apache Spark" href="../cluster-uber-trip-data/cluster-uber-trip-data.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="docsearch:language" content="en">



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  <img src="../_static/logo.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">Anindya's Blog</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   Welcome to your Jupyter Book
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Machine Learning With Python
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../bcg/breast-cancer-risk-prediction-classification.html">
   Classification: Predict Diagnosis of a Breast Tumor as Malignant or Benign
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../bc/breast-cancer-risk-prediction-classification.html">
   Classification: Predict Diagnosis of a Breast Tumor as Malignant or Benign
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../kg/kaggle-bike-sharing-demand.html">
   Kaggle - Predicting Bike Sharing Demand
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Data Science with Spark
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../cluster-uber-trip-data/cluster-uber-trip-data.html">
   Clustering Uber’s Trip Data with Apache Spark
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Advanced Data Analysis of a Retail Store using Apache Spark (PySpark)
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Leetcode Solutions
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../leetcode/lc5455.html">
   5455. Minimum Number of Days to Make m Bouquets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../leetcode/lc5455.html#solution">
   Solution
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../leetcode/lc5456.html">
   5456. Kth Ancestor of a Tree Node
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/retail-database-analysis-python/retail-database-analysis-python.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#table-of-contents">
   Table of contents
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#understanding-the-data-set">
   1. Understanding the Data Set:
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#creating-the-spark-session">
   2. Creating the Spark Session:
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-the-data-from-files-into-dataframes">
   3. Load the Data From Files Into DataFrames:
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#register-all-the-dataframes-as-temporary-views">
     3.1. Register all the DataFrames as Temporary Views:
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-analysis">
   4. Data Analysis:
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-how-many-orders-were-placed">
     4.1 Get How many Orders were placed:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-average-revenue-per-order">
     4.2 Get Average Revenue Per Order:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-average-revenue-per-day">
     4.3 Get Average Revenue Per Day:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-average-revenue-per-month">
     4.3.1 Get Average Revenue Per Month:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-total-revenue-per-month-per-year">
     4.3.2 Get Total Revenue Per Month Per Year:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#group-revenues-per-month-per-year">
     4.4 Group Revenues per Month per Year:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#top-performing-departments">
     4.5 Top Performing Departments:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-highest-priced-product">
     4.6 Get Highest Priced Product:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-highest-revenue-earning-products">
     4.7 Get Highest Revenue Earning Products:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#top-5-highest-revenue-earning-products-per-month-per-year">
     4.8 Top 5 Highest Revenue Earning Products Per Month Per Year:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-the-most-popular-categories">
     4.9 Get the most popular Categories:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-the-revenue-for-each-category-per-year-per-quarter">
     4.10 Get the revenue for each Category Per Year Per Quarter:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-number-of-orders-by-status">
     4.11 Get Number of Orders By Status:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-number-of-orders-by-order-date-and-order-status">
     4.12 Get Number of Orders By Order Date and Order Status:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-all-canceled-orders-with-amount-greater-than-1000">
     4.13 Get all CANCELED orders with amount greater than $1000:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sort-products-by-category-and-price">
     4.14 Sort Products by Category and Price:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sort-products-by-price-within-each-category">
     4.15 Sort Products by Price within Each Category:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-the-topmost-5-products-overall-sorted-by-price-highest-to-lowest">
     4.16 Get the topmost 5 products overall sorted by Price Highest to Lowest:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-the-topmost-5-products-in-each-category-where-the-products-are-sorted-by-price-highest-to-lowest">
     4.17 Get the topmost 5 products in each category where the products are sorted by Price Highest to Lowest:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#rank-and-dense-rank">
     RANK and DENSE_RANK
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-topn-products-by-price-in-each-category">
     4.18 Get topN products by price in each category:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-topn-priced-products-in-each-category">
     4.19 Get ‘topN priced’ products in each category:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-the-customer-id-with-max-revenue-on-daily-basis">
     4.20 Get the Customer Id with max revenue on Daily basis:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-the-top-3-max-revenue-generating-customers-per-month-in-2013">
     4.21 Get the top 3 Max Revenue Generating Customers Per Month in 2013:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-all-distinct-pair-of-products-the-occurred-in-orders-where-order-total-was-greater-than-300">
     4.22 Get All Distinct Pair of Products the occurred in Orders where order total was greater than 300:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-all-customers-who-didn-t-place-an-order-in-august-2013">
     4.23 Get All Customers who didn’t place an order in August 2013:
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-all-customers-who-placed-more-than-5-orders-in-august-2013">
     4.24 Get All Customers who placed more than 5 orders in August 2013:
    </a>
   </li>
  </ul>
 </li>
</ul>

        </nav>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="advanced-data-analysis-of-a-retail-store-using-apache-spark-pyspark">
<h1>Advanced Data Analysis of a Retail Store using Apache Spark (PySpark)<a class="headerlink" href="#advanced-data-analysis-of-a-retail-store-using-apache-spark-pyspark" title="Permalink to this headline">¶</a></h1>
<p>In this notebook we will go through Spark SQL as well as Spark DF API based transformations and actions ranging from simple to quite complex. I use this as a reference in my day to day job. These tables come from the Cloudera Installation. A fictitious retail house with the following tables: customers, departments, categories, products, orders and order_items.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@author</span><span class="p">:</span> <span class="n">Anindya</span> <span class="n">Saha</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@email</span><span class="p">:</span> <span class="n">mail</span><span class="o">.</span><span class="n">anindya</span><span class="nd">@gmail</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<div class="section" id="table-of-contents">
<h2>Table of contents<a class="headerlink" href="#table-of-contents" title="Permalink to this headline">¶</a></h2>
<p>A brief synopsis of what each use case is and what functionality of the SPARK SQL or DF API does it touch on.</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p>Section</p></th>
<th class="text-align:left head"><p>Demonstrates</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p><a class="reference external" href="#1.-Understanding-the-Data-Set:">1. Understanding the Data Set</a></p></td>
<td class="text-align:left"><p></p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><a class="reference external" href="#2.-Creating-the-Spark-Session:">2. Creating the Spark Session</a></p></td>
<td class="text-align:left"><p></p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p><a class="reference external" href="#3.-Load-the-Data-From-Files-Into-DataFrames:">3. Load the Data From Files Into DataFrames</a></p></td>
<td class="text-align:left"><p></p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><a class="reference external" href="#4.1-Get-How-many-Orders-were-placed:">4.1 Get How many Orders were placed</a></p></td>
<td class="text-align:left"><p>COUNT</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p><a class="reference external" href="#4.2-Get-Average-Revenue-Per-Order:">4.2 Get Average Revenue Per Order</a></p></td>
<td class="text-align:left"><p>COUNT, JOIN</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><a class="reference external" href="#4.1-Get-How-many-Orders-were-placed:">4.3 Get Average Revenue Per Day</a></p></td>
<td class="text-align:left"><p>SUM, COUNT, JOIN, GROUP BY, AGG, ORDER BY</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p><a class="reference external" href="#4.3.1-Get-Average-Revenue-Per-Month:">4.3.1 Get Average Revenue Per Month</a></p></td>
<td class="text-align:left"><p>MONTH, AVG, JOIN, GROUP BY, ORDER BY</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><a class="reference external" href="#4.3.2-Get-Total-Revenue-Per-Month-Per-Year:">4.3.2 Get Total Revenue Per Month Per Year</a></p></td>
<td class="text-align:left"><p>MONTH, AVG, JOIN, GROUP BY, ORDER BY</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p><a class="reference external" href="#4.4-Group-Revenues-per-Month-per-Year:">4.4 Group Revenues per Month per Year</a></p></td>
<td class="text-align:left"><p>GROUPING SETS, ROLLUP, CUBE</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><a class="reference external" href="#4.5-Top-Performing-Departments:">4.5 Top Performing Departments</a></p></td>
<td class="text-align:left"><p>MULTI TABLE JOINS, GROUP BY, ORDER BY</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p><a class="reference external" href="#4.6-Get-Highest-Priced-Product:">4.6 Get Highest Priced Product</a></p></td>
<td class="text-align:left"><p>SCALER SUB QUERY, WINDOW, RANK</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><a class="reference external" href="#4.7-Get-Highest-Revenue-Earning-Products:">4.7 Get Highest Revenue Earning Products</a></p></td>
<td class="text-align:left"><p>UNCORRELATED SUB QUERY</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p><a class="reference external" href="#4.8-Top-5-Highest-Revenue-Earning-Products-Per-Month-Per-Year:">4.8 Top 5 Highest Revenue Earning Products Per Month Per Year</a></p></td>
<td class="text-align:left"><p>INNER SUB QUERY, WINDOW, DENSE RANK, UDF</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><a class="reference external" href="#4.9-Get-the-most-popular-Categories:">4.9 Get the most popular Categories</a></p></td>
<td class="text-align:left"><p>ORDER BY, LIMIT</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p><a class="reference external" href="#4.10-Get-the-revenue-for-each-Category-Per-Year-Per-Quarter:">4.10 Get the revenue for each Category Per Year Per Quarter</a></p></td>
<td class="text-align:left"><p>PIVOT, COALESCE, INNER QUERY</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><a class="reference external" href="#4.11-Get-Number-of-Orders-By-Status:">4.11 Get Number of Orders By Status</a></p></td>
<td class="text-align:left"><p>COUNT</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p><a class="reference external" href="#4.12-Get-Number-of-Orders-By-Order-Date-and-Order-Status:">4.12 Get Number of Orders By Order Date and Order Status</a></p></td>
<td class="text-align:left"><p>COUNT, GROUP BY</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><a class="reference external" href="#4.13-Get-all-CANCELED-orders-with-amount-greater-than-%241000:">4.13 Get all CANCELED orders with amount greater than $1000</a></p></td>
<td class="text-align:left"><p>FILTER, SUM, AGG, GROUP BY</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p><a class="reference external" href="#4.14-Sort-Products-by-Category-and-Price:">4.14 Sort Products by Category and Price</a></p></td>
<td class="text-align:left"><p>ORDER BY</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><a class="reference external" href="#4.15-Sort-Products-by-Price-within-Each-Category:">4.15 Sort Products by Price within Each Category</a></p></td>
<td class="text-align:left"><p>DISTRIBUTE BY, SORT WITHIN PARTITIONS</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p><a class="reference external" href="#4.16-Get-the-topmost-5-products-overall-sorted-by-Price-Highest-to-Lowest:">4.16 Get the topmost 5 products overall sorted by Price Highest to Lowest</a></p></td>
<td class="text-align:left"><p>ORDER BY, LIMIT</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><a class="reference external" href="#4.17-Get-the-topmost-5-products-in-each-category-where-the-products-are-sorted-by-Price-Highest-to-Lowest:">4.17 Get the topmost 5 products in each category where the products are sorted by Price Highest to Lowest</a></p></td>
<td class="text-align:left"><p>WINDOW, ROW_NUMBER</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p><a class="reference external" href="#4.18-Get-topN-products-by-price-in-each-category:">4.18 Get topN products by price in each category</a></p></td>
<td class="text-align:left"><p>WINDOW, RANK</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><a class="reference external" href="#4.19-Get-%27topN-priced%27-products-in-each-category:">4.19 Get ‘topN priced’ products in each category</a></p></td>
<td class="text-align:left"><p>WINDOW, DENSE_RANK</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p><a class="reference external" href="#4.20-Get-the-Customer-Id-with-max-revenue-on-Daily-basis:">4.20 Get the Customer Id with max revenue on Daily basis</a></p></td>
<td class="text-align:left"><p>WINDOW, RANK, JOIN</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><a class="reference external" href="#4.21-Get-the-top-3-Max-Revenue-Generating-Customers-Per-Month-in-2013:">4.21 Get the top 3 Max Revenue Generating Customers Per Month in 2013</a></p></td>
<td class="text-align:left"><p>WINDOW, DENSE_RANK, JOIN, SUBQUERY, UDF</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p><a class="reference external" href="#4.22-Get-All-Distinct-Pair-of-Products-the-occurred-in-Orders-where-order-total-was-greater-than-300:">4.22 Get All Distinct Pair of Products the occurred in Orders where order total was greater than 300</a></p></td>
<td class="text-align:left"><p>SELF JOIN</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><a class="reference external" href="#4.23-Get-All-Customers-who-didn%27t-place-an-order-in-August-2013:">4.23 Get All Customers who didn’t place an order in August 2013</a></p></td>
<td class="text-align:left"><p>LEFT ANTI JOIN</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p><a class="reference external" href="#4.24-Get-All-Customers-who-placed-more-than-5-orders-in-August-2013:">4.24 Get All Customers who placed more than 5 orders in August 2013</a></p></td>
<td class="text-align:left"><p>HAVING CLAUSE</p></td>
</tr>
</tbody>
</table>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">pyspark</span> <span class="kn">import</span> <span class="n">SparkConf</span><span class="p">,</span> <span class="n">SparkContext</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span><span class="p">,</span> <span class="n">SQLContext</span>

<span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.window</span> <span class="kn">import</span> <span class="n">Window</span>

<span class="kn">import</span> <span class="nn">pyspark.sql.functions</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">udf</span><span class="p">,</span> <span class="n">col</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualization</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Visualization</span>
<span class="kn">from</span> <span class="nn">IPython.core.interactiveshell</span> <span class="kn">import</span> <span class="n">InteractiveShell</span>
<span class="n">InteractiveShell</span><span class="o">.</span><span class="n">ast_node_interactivity</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span>

<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_colwidth&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="s1">&#39;notebook&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;whitegrid&#39;</span><span class="p">,</span> <span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">4</span><span class="p">)})</span>
<span class="c1">#rcParams[&#39;figure.figsize&#39;] = 18,4</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># this allows plots to appear directly in the notebook</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="o">%</span><span class="n">config</span> <span class="n">InlineBackend</span><span class="o">.</span><span class="n">figure_format</span> <span class="o">=</span> <span class="s1">&#39;retina&#39;</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">rcParams</span>
<span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">18</span><span class="p">,</span><span class="mi">4</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># setting random seed for notebook reproducability</span>
<span class="n">rnd_seed</span><span class="o">=</span><span class="mi">23</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="o">=</span><span class="n">rnd_seed</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_state</span><span class="o">=</span><span class="n">rnd_seed</span>
</pre></div>
</div>
</div>
<div class="section" id="understanding-the-data-set">
<h2>1. Understanding the Data Set:<a class="headerlink" href="#understanding-the-data-set" title="Permalink to this headline">¶</a></h2>
<p><img alt="" src="../_images/cloudera-retail-db.png" />
Picture Source: https://www.cloudera.com/developers/get-started-with-hadoop-tutorial/exercise-1.html</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mysql&gt; describe customers<span class="p">;</span>
+-------------------+--------------+------+-----+---------+----------------+
<span class="p">|</span> Field             <span class="p">|</span> Type         <span class="p">|</span> Null <span class="p">|</span> Key <span class="p">|</span> Default <span class="p">|</span> Extra          <span class="p">|</span>
+-------------------+--------------+------+-----+---------+----------------+
<span class="p">|</span> customer_id       <span class="p">|</span> int<span class="o">(</span><span class="m">11</span><span class="o">)</span>      <span class="p">|</span> NO   <span class="p">|</span> PRI <span class="p">|</span> NULL    <span class="p">|</span> auto_increment <span class="p">|</span>
<span class="p">|</span> customer_fname    <span class="p">|</span> varchar<span class="o">(</span><span class="m">45</span><span class="o">)</span>  <span class="p">|</span> NO   <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
<span class="p">|</span> customer_lname    <span class="p">|</span> varchar<span class="o">(</span><span class="m">45</span><span class="o">)</span>  <span class="p">|</span> NO   <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
<span class="p">|</span> customer_email    <span class="p">|</span> varchar<span class="o">(</span><span class="m">45</span><span class="o">)</span>  <span class="p">|</span> NO   <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
<span class="p">|</span> customer_password <span class="p">|</span> varchar<span class="o">(</span><span class="m">45</span><span class="o">)</span>  <span class="p">|</span> NO   <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
<span class="p">|</span> customer_street   <span class="p">|</span> varchar<span class="o">(</span><span class="m">255</span><span class="o">)</span> <span class="p">|</span> NO   <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
<span class="p">|</span> customer_city     <span class="p">|</span> varchar<span class="o">(</span><span class="m">45</span><span class="o">)</span>  <span class="p">|</span> NO   <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
<span class="p">|</span> customer_state    <span class="p">|</span> varchar<span class="o">(</span><span class="m">45</span><span class="o">)</span>  <span class="p">|</span> NO   <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
<span class="p">|</span> customer_zipcode  <span class="p">|</span> varchar<span class="o">(</span><span class="m">45</span><span class="o">)</span>  <span class="p">|</span> NO   <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
+-------------------+--------------+------+-----+---------+----------------+

mysql&gt; describe departments<span class="p">;</span>
+-----------------+-------------+------+-----+---------+----------------+
<span class="p">|</span> Field           <span class="p">|</span> Type        <span class="p">|</span> Null <span class="p">|</span> Key <span class="p">|</span> Default <span class="p">|</span> Extra          <span class="p">|</span>
+-----------------+-------------+------+-----+---------+----------------+
<span class="p">|</span> department_id   <span class="p">|</span> int<span class="o">(</span><span class="m">11</span><span class="o">)</span>     <span class="p">|</span> NO   <span class="p">|</span> PRI <span class="p">|</span> NULL    <span class="p">|</span> auto_increment <span class="p">|</span>
<span class="p">|</span> department_name <span class="p">|</span> varchar<span class="o">(</span><span class="m">45</span><span class="o">)</span> <span class="p">|</span> NO   <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
+-----------------+-------------+------+-----+---------+----------------+

mysql&gt; describe categories<span class="p">;</span>
+------------------------+-------------+------+-----+---------+----------------+
<span class="p">|</span> Field                  <span class="p">|</span> Type        <span class="p">|</span> Null <span class="p">|</span> Key <span class="p">|</span> Default <span class="p">|</span> Extra          <span class="p">|</span>
+------------------------+-------------+------+-----+---------+----------------+
<span class="p">|</span> category_id            <span class="p">|</span> int<span class="o">(</span><span class="m">11</span><span class="o">)</span>     <span class="p">|</span> NO   <span class="p">|</span> PRI <span class="p">|</span> NULL    <span class="p">|</span> auto_increment <span class="p">|</span>
<span class="p">|</span> category_department_id <span class="p">|</span> int<span class="o">(</span><span class="m">11</span><span class="o">)</span>     <span class="p">|</span> NO   <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
<span class="p">|</span> category_name          <span class="p">|</span> varchar<span class="o">(</span><span class="m">45</span><span class="o">)</span> <span class="p">|</span> NO   <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
+------------------------+-------------+------+-----+---------+----------------+

mysql&gt; describe products<span class="p">;</span>
+---------------------+--------------+------+-----+---------+----------------+
<span class="p">|</span> Field               <span class="p">|</span> Type         <span class="p">|</span> Null <span class="p">|</span> Key <span class="p">|</span> Default <span class="p">|</span> Extra          <span class="p">|</span>
+---------------------+--------------+------+-----+---------+----------------+
<span class="p">|</span> product_id          <span class="p">|</span> int<span class="o">(</span><span class="m">11</span><span class="o">)</span>      <span class="p">|</span> NO   <span class="p">|</span> PRI <span class="p">|</span> NULL    <span class="p">|</span> auto_increment <span class="p">|</span>
<span class="p">|</span> product_category_id <span class="p">|</span> int<span class="o">(</span><span class="m">11</span><span class="o">)</span>      <span class="p">|</span> NO   <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
<span class="p">|</span> product_name        <span class="p">|</span> varchar<span class="o">(</span><span class="m">45</span><span class="o">)</span>  <span class="p">|</span> NO   <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
<span class="p">|</span> product_description <span class="p">|</span> varchar<span class="o">(</span><span class="m">255</span><span class="o">)</span> <span class="p">|</span> NO   <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
<span class="p">|</span> product_price       <span class="p">|</span> float        <span class="p">|</span> NO   <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
<span class="p">|</span> product_image       <span class="p">|</span> varchar<span class="o">(</span><span class="m">255</span><span class="o">)</span> <span class="p">|</span> NO   <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
+---------------------+--------------+------+-----+---------+----------------+

mysql&gt; describe orders<span class="p">;</span>
+-------------------+-------------+------+-----+---------+----------------+
<span class="p">|</span> Field             <span class="p">|</span> Type        <span class="p">|</span> Null <span class="p">|</span> Key <span class="p">|</span> Default <span class="p">|</span> Extra          <span class="p">|</span>
+-------------------+-------------+------+-----+---------+----------------+
<span class="p">|</span> order_id          <span class="p">|</span> int<span class="o">(</span><span class="m">11</span><span class="o">)</span>     <span class="p">|</span> NO   <span class="p">|</span> PRI <span class="p">|</span> NULL    <span class="p">|</span> auto_increment <span class="p">|</span>
<span class="p">|</span> order_date        <span class="p">|</span> datetime    <span class="p">|</span> NO   <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
<span class="p">|</span> order_customer_id <span class="p">|</span> int<span class="o">(</span><span class="m">11</span><span class="o">)</span>     <span class="p">|</span> NO   <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
<span class="p">|</span> order_status      <span class="p">|</span> varchar<span class="o">(</span><span class="m">45</span><span class="o">)</span> <span class="p">|</span> NO   <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
+-------------------+-------------+------+-----+---------+----------------+

mysql&gt; describe order_items<span class="p">;</span>
+--------------------------+------------+------+-----+---------+----------------+
<span class="p">|</span> Field                    <span class="p">|</span> Type       <span class="p">|</span> Null <span class="p">|</span> Key <span class="p">|</span> Default <span class="p">|</span> Extra          <span class="p">|</span>
+--------------------------+------------+------+-----+---------+----------------+
<span class="p">|</span> order_item_id            <span class="p">|</span> int<span class="o">(</span><span class="m">11</span><span class="o">)</span>    <span class="p">|</span> NO   <span class="p">|</span> PRI <span class="p">|</span> NULL    <span class="p">|</span> auto_increment <span class="p">|</span>
<span class="p">|</span> order_item_order_id      <span class="p">|</span> int<span class="o">(</span><span class="m">11</span><span class="o">)</span>    <span class="p">|</span> NO   <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
<span class="p">|</span> order_item_product_id    <span class="p">|</span> int<span class="o">(</span><span class="m">11</span><span class="o">)</span>    <span class="p">|</span> NO   <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
<span class="p">|</span> order_item_quantity      <span class="p">|</span> tinyint<span class="o">(</span><span class="m">4</span><span class="o">)</span> <span class="p">|</span> NO   <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
<span class="p">|</span> order_item_subtotal      <span class="p">|</span> float      <span class="p">|</span> NO   <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
<span class="p">|</span> order_item_product_price <span class="p">|</span> float      <span class="p">|</span> NO   <span class="p">|</span>     <span class="p">|</span> NULL    <span class="p">|</span>                <span class="p">|</span>
+--------------------------+------------+------+-----+---------+----------------+
</pre></div>
</div>
<p><a class="reference external" href="##Table-of-contents">Back to Top</a></p>
</div>
<div class="section" id="creating-the-spark-session">
<h2>2. Creating the Spark Session:<a class="headerlink" href="#creating-the-spark-session" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># The following must be set in your .bashrc file</span>
<span class="c1">#SPARK_HOME=&quot;/home/ubuntu/spark-2.4.0-bin-hadoop2.7&quot;</span>
<span class="c1">#ANACONDA_HOME=&quot;/home/ubuntu/anaconda3/envs/pyspark&quot;</span>
<span class="c1">#PYSPARK_PYTHON=&quot;$ANACONDA_HOME/bin/python&quot;</span>
<span class="c1">#PYSPARK_DRIVER_PYTHON=&quot;$ANACONDA_HOME/bin/python&quot;</span>
<span class="c1">#PYTHONPATH=&quot;$ANACONDA_HOME/bin/python&quot;</span>
<span class="c1">#export PATH=&quot;$ANACONDA_HOME/bin:$SPARK_HOME/bin:$PATH&quot;</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span> <span class="o">=</span> <span class="p">(</span><span class="n">SparkSession</span>
         <span class="o">.</span><span class="n">builder</span>
         <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">&quot;local[*]&quot;</span><span class="p">)</span>
         <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;retail-database-analysis-python&quot;</span><span class="p">)</span>
         <span class="o">.</span><span class="n">getOrCreate</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span>
</pre></div>
</div>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">b</span><span class="p">&gt;</span>SparkContext<span class="p">&lt;/</span><span class="nt">b</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">b</span><span class="p">&gt;</span>SparkSession - in-memory<span class="p">&lt;/</span><span class="nt">b</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;http://ip-172-30-2-158.ec2.internal:4040&quot;</span><span class="p">&gt;</span>Spark UI<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">dl</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>Version<span class="p">&lt;/</span><span class="nt">dt</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>v2.4.0<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>Master<span class="p">&lt;/</span><span class="nt">dt</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>local[*]<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">dt</span><span class="p">&gt;</span>AppName<span class="p">&lt;/</span><span class="nt">dt</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">dd</span><span class="p">&gt;&lt;</span><span class="nt">code</span><span class="p">&gt;</span>retail-database-analysis-python<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;&lt;/</span><span class="nt">dd</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">dl</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sqlContext</span> <span class="o">=</span> <span class="n">SQLContext</span><span class="p">(</span><span class="n">spark</span><span class="o">.</span><span class="n">sparkContext</span><span class="p">)</span>
<span class="n">sqlContext</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;pyspark.sql.context.SQLContext at 0x7fae65c09588&gt;
</pre></div>
</div>
<p><a class="reference external" href="#Table-of-contents">Back to Top</a></p>
</div>
<div class="section" id="load-the-data-from-files-into-dataframes">
<h2>3. Load the Data From Files Into DataFrames:<a class="headerlink" href="#load-the-data-from-files-into-dataframes" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">CUSTOMERS_DATA</span> <span class="o">=</span>   <span class="s1">&#39;data/customers.csv&#39;</span>
<span class="n">DEPARTMENTS_DATA</span> <span class="o">=</span> <span class="s1">&#39;data/departments.csv&#39;</span>
<span class="n">CATEGORIES_DATA</span> <span class="o">=</span>  <span class="s1">&#39;data/categories.csv&#39;</span>
<span class="n">PRODUCTS_DATA</span> <span class="o">=</span>    <span class="s1">&#39;data/products.csv&#39;</span>
<span class="n">ORDERS_DATA</span> <span class="o">=</span>      <span class="s1">&#39;data/orders.csv&#39;</span>
<span class="n">ORDER_ITEMS_DATA</span> <span class="o">=</span> <span class="s1">&#39;data/order_items.csv&#39;</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># define the schema, corresponding to a line in the csv data file for Customer</span>
<span class="n">customers_schema</span> <span class="o">=</span> <span class="n">StructType</span><span class="p">([</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;customer_id&#39;</span><span class="p">,</span>       <span class="n">IntegerType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;customer_fname&#39;</span><span class="p">,</span>    <span class="n">StringType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;customer_lname&#39;</span><span class="p">,</span>    <span class="n">StringType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;customer_email&#39;</span><span class="p">,</span>    <span class="n">StringType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;customer_password&#39;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;customer_street&#39;</span><span class="p">,</span>   <span class="n">StringType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;customer_city&#39;</span><span class="p">,</span>     <span class="n">StringType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;customer_state&#39;</span><span class="p">,</span>    <span class="n">StringType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;customer_zipcode&#39;</span><span class="p">,</span>  <span class="n">StringType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)])</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">departments_schema</span> <span class="o">=</span> <span class="n">StructType</span><span class="p">([</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;department_id&#39;</span><span class="p">,</span>   <span class="n">IntegerType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;department_name&#39;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)])</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">categories_schema</span> <span class="o">=</span> <span class="n">StructType</span><span class="p">([</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;category_id&#39;</span><span class="p">,</span>            <span class="n">IntegerType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;category_department_id&#39;</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;category_name&#39;</span><span class="p">,</span>          <span class="n">StringType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)])</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">products_schema</span> <span class="o">=</span> <span class="n">StructType</span><span class="p">([</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;product_id&#39;</span><span class="p">,</span>          <span class="n">IntegerType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;product_category_id&#39;</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;product_name&#39;</span><span class="p">,</span>        <span class="n">StringType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;product_description&#39;</span><span class="p">,</span> <span class="n">StringType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;product_price&#39;</span><span class="p">,</span>       <span class="n">FloatType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;product_image&#39;</span><span class="p">,</span>       <span class="n">StringType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)])</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">orders_schema</span> <span class="o">=</span> <span class="n">StructType</span><span class="p">([</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;order_id&#39;</span><span class="p">,</span>          <span class="n">IntegerType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;order_date&#39;</span><span class="p">,</span>        <span class="n">StringType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;order_customer_id&#39;</span><span class="p">,</span> <span class="n">IntegerType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;order_status&#39;</span><span class="p">,</span>      <span class="n">StringType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)])</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">order_items_schema</span> <span class="o">=</span> <span class="n">StructType</span><span class="p">([</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;order_item_id&#39;</span><span class="p">,</span>            <span class="n">IntegerType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;order_item_order_id&#39;</span><span class="p">,</span>      <span class="n">IntegerType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;order_item_product_id&#39;</span><span class="p">,</span>    <span class="n">IntegerType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;order_item_quantity&#39;</span><span class="p">,</span>      <span class="n">IntegerType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;order_item_subtotal&#39;</span><span class="p">,</span>      <span class="n">FloatType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">StructField</span><span class="p">(</span><span class="s1">&#39;order_item_product_price&#39;</span><span class="p">,</span> <span class="n">FloatType</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)])</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load data</span>
<span class="n">customers_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">CUSTOMERS_DATA</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">customers_schema</span><span class="p">)</span>
<span class="n">customers_df</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>

<span class="n">departments_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">DEPARTMENTS_DATA</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">departments_schema</span><span class="p">)</span>
<span class="n">departments_df</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>

<span class="n">categories_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">CATEGORIES_DATA</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">categories_schema</span><span class="p">)</span>
<span class="n">categories_df</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>

<span class="n">products_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">PRODUCTS_DATA</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">products_schema</span><span class="p">)</span>
<span class="n">products_df</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>

<span class="n">orders_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">ORDERS_DATA</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">orders_schema</span><span class="p">)</span>
<span class="n">orders_df</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>

<span class="n">order_items_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">ORDER_ITEMS_DATA</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">order_items_schema</span><span class="p">)</span>
<span class="n">order_items_df</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
</div>
<p><a class="reference external" href="#Table-of-contents">Back to Top</a></p>
<div class="section" id="register-all-the-dataframes-as-temporary-views">
<h3>3.1. Register all the DataFrames as Temporary Views:<a class="headerlink" href="#register-all-the-dataframes-as-temporary-views" title="Permalink to this headline">¶</a></h3>
<p>We cache all the dataframes because we would be using them again and again in different use cases below.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">customers_df</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s2">&quot;customers&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">customers_df</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">col</span><span class="p">(</span><span class="n">choice</span><span class="p">)</span> <span class="k">for</span> <span class="n">choice</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">customers_df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)])</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+--------------------+--------------+-----------+--------------+----------------+
|     customer_street|customer_state|customer_id|customer_fname|customer_zipcode|
+--------------------+--------------+-----------+--------------+----------------+
|  6303 Heather Plaza|            TX|          1|       Richard|           78521|
|9526 Noble Embers...|            CO|          2|          Mary|           80126|
|3422 Blue Pioneer...|            PR|          3|           Ann|           00725|
|  8324 Little Common|            CA|          4|          Mary|           92069|
|10 Crystal River ...|            PR|          5|        Robert|           00725|
+--------------------+--------------+-----------+--------------+----------------+
only showing top 5 rows
</pre></div>
</div>
<p>​</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">departments_df</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s2">&quot;departments&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">departments_df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-------------+---------------+
|department_id|department_name|
+-------------+---------------+
|            2|        Fitness|
|            3|       Footwear|
|            4|        Apparel|
|            5|           Golf|
|            6|       Outdoors|
+-------------+---------------+
only showing top 5 rows
</pre></div>
</div>
<p>​</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">categories_df</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s2">&quot;categories&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">categories_df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-----------+----------------------+-------------------+
|category_id|category_department_id|      category_name|
+-----------+----------------------+-------------------+
|          1|                     2|           Football|
|          2|                     2|             Soccer|
|          3|                     2|Baseball &amp; Softball|
|          4|                     2|         Basketball|
|          5|                     2|           Lacrosse|
+-----------+----------------------+-------------------+
only showing top 5 rows
</pre></div>
</div>
<p>​</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">products_df</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s2">&quot;products&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">products_df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+----------+-------------------+--------------------+-------------------+-------------+--------------------+
|product_id|product_category_id|        product_name|product_description|product_price|       product_image|
+----------+-------------------+--------------------+-------------------+-------------+--------------------+
|         1|                  2|Quest Q64 10 FT. ...|               null|        59.98|http://images.acm...|
|         2|                  2|Under Armour Men&#39;...|               null|       129.99|http://images.acm...|
|         3|                  2|Under Armour Men&#39;...|               null|        89.99|http://images.acm...|
|         4|                  2|Under Armour Men&#39;...|               null|        89.99|http://images.acm...|
|         5|                  2|Riddell Youth Rev...|               null|       199.99|http://images.acm...|
+----------+-------------------+--------------------+-------------------+-------------+--------------------+
only showing top 5 rows
</pre></div>
</div>
<p>​</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">orders_df</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s2">&quot;orders&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">orders_df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+--------+--------------------+-----------------+---------------+
|order_id|          order_date|order_customer_id|   order_status|
+--------+--------------------+-----------------+---------------+
|       1|2013-07-25 00:00:...|            11599|         CLOSED|
|       2|2013-07-25 00:00:...|              256|PENDING_PAYMENT|
|       3|2013-07-25 00:00:...|            12111|       COMPLETE|
|       4|2013-07-25 00:00:...|             8827|         CLOSED|
|       5|2013-07-25 00:00:...|            11318|       COMPLETE|
+--------+--------------------+-----------------+---------------+
only showing top 5 rows
</pre></div>
</div>
<p>​</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">order_items_df</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s2">&quot;order_items&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">order_items_df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-------------+-------------------+---------------------+-------------------+-------------------+------------------------+
|order_item_id|order_item_order_id|order_item_product_id|order_item_quantity|order_item_subtotal|order_item_product_price|
+-------------+-------------------+---------------------+-------------------+-------------------+------------------------+
|            1|                  1|                  957|                  1|             299.98|                  299.98|
|            2|                  2|                 1073|                  1|             199.99|                  199.99|
|            3|                  2|                  502|                  5|              250.0|                    50.0|
|            4|                  2|                  403|                  1|             129.99|                  129.99|
|            5|                  4|                  897|                  2|              49.98|                   24.99|
+-------------+-------------------+---------------------+-------------------+-------------------+------------------------+
only showing top 5 rows
</pre></div>
</div>
<p>​</p>
<p><a class="reference external" href="#Table-of-contents">Back to Top</a></p>
</div>
</div>
<div class="section" id="data-analysis">
<h2>4. Data Analysis:<a class="headerlink" href="#data-analysis" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>

<span class="k">def</span> <span class="nf">strip_margin</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">nomargin</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[ </span><span class="se">\t</span><span class="s1">]*\|&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">trimmed</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">nomargin</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">trimmed</span>
</pre></div>
</div>
<div class="section" id="get-how-many-orders-were-placed">
<h3>4.1 Get How many Orders were placed:<a class="headerlink" href="#get-how-many-orders-were-placed" title="Permalink to this headline">¶</a></h3>
<p><strong>SQL:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;select count(order_id) from orders&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+---------------+
|count(order_id)|
+---------------+
|          68883|
+---------------+
</pre></div>
</div>
<p>​</p>
<p><strong>DF API:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">orders_df</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>68883
</pre></div>
</div>
<p><a class="reference external" href="#Table-of-contents">Back to Top</a></p>
</div>
<div class="section" id="get-average-revenue-per-order">
<h3>4.2 Get Average Revenue Per Order:<a class="headerlink" href="#get-average-revenue-per-order" title="Permalink to this headline">¶</a></h3>
<p><strong>SQL:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Some orders are cancelled and they do not have corresponding entries in order_items, </span>
<span class="c1"># so we need count(distinct oi.order_item_order_id)</span>
<span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;SELECT SUM(oi.order_item_subtotal) / COUNT(DISTINCT oi.order_item_order_id) as avg_rev_per_order</span>
<span class="sd">          |FROM orders o JOIN order_items oi </span>
<span class="sd">          |ON o.order_id = oi.order_item_order_id</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-----------------+
|avg_rev_per_order|
+-----------------+
|597.6322996016944|
+-----------------+
</pre></div>
</div>
<p>​</p>
<p><strong>DF API:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># how best to join two DataFrames without having a duplicated colum? Mention them as expression</span>
<span class="p">(</span><span class="n">orders_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">order_items_df</span><span class="p">,</span> <span class="n">orders_df</span><span class="o">.</span><span class="n">order_id</span> <span class="o">==</span> <span class="n">order_items_df</span><span class="o">.</span><span class="n">order_item_order_id</span><span class="p">)</span>
 <span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s1">&#39;order_item_subtotal&#39;</span><span class="p">,</span> <span class="s1">&#39;order_item_order_id&#39;</span><span class="p">])</span>
 <span class="o">.</span><span class="n">select</span><span class="p">((</span><span class="n">F</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">&#39;order_item_subtotal&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">F</span><span class="o">.</span><span class="n">countDistinct</span><span class="p">(</span><span class="s1">&#39;order_item_order_id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;avg_rev_per_order&#39;</span><span class="p">))</span>
 <span class="o">.</span><span class="n">show</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-----------------+
|avg_rev_per_order|
+-----------------+
|597.6322996016944|
+-----------------+
</pre></div>
</div>
<p>​</p>
</div>
<div class="section" id="get-average-revenue-per-day">
<h3>4.3 Get Average Revenue Per Day:<a class="headerlink" href="#get-average-revenue-per-day" title="Permalink to this headline">¶</a></h3>
<p><strong>SQL:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Some orders are cancelled and they do not have corresponding entries in order_items, </span>
<span class="c1"># so we need count(distinct oi.order_item_order_id)</span>
<span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;SELECT o.order_date, sum(oi.order_item_subtotal) / COUNT(DISTINCT oi.order_item_order_id) as avg_rev_per_day</span>
<span class="sd">          |FROM orders o JOIN order_items oi </span>
<span class="sd">          |    ON o.order_id = oi.order_item_order_id</span>
<span class="sd">          |GROUP BY o.order_date </span>
<span class="sd">          |ORDER BY o.order_date</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+---------------------+-----------------+
|order_date           |avg_rev_per_day  |
+---------------------+-----------------+
|2013-07-25 00:00:00.0|587.5330286848134|
|2013-07-26 00:00:00.0|585.9234878147109|
|2013-07-27 00:00:00.0|577.5676682063512|
|2013-07-28 00:00:00.0|551.4119109020958|
|2013-07-29 00:00:00.0|635.5883909684641|
|2013-07-30 00:00:00.0|564.5363838698838|
|2013-07-31 00:00:00.0|630.9955146643533|
|2013-08-01 00:00:00.0|608.4982189502356|
|2013-08-02 00:00:00.0|587.8871075517388|
|2013-08-03 00:00:00.0|599.1628419048382|
|2013-08-04 00:00:00.0|594.3201416863335|
|2013-08-05 00:00:00.0|592.8305590897799|
|2013-08-06 00:00:00.0|579.68106844792  |
|2013-08-07 00:00:00.0|583.906170096101 |
|2013-08-08 00:00:00.0|588.4743191939134|
|2013-08-09 00:00:00.0|629.4593056380147|
|2013-08-10 00:00:00.0|586.3113241756664|
|2013-08-11 00:00:00.0|551.5472206441007|
|2013-08-12 00:00:00.0|612.4790563343757|
|2013-08-13 00:00:00.0|604.1594044945457|
+---------------------+-----------------+
only showing top 20 rows
</pre></div>
</div>
<p>​</p>
<p><strong>DF API:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">avg_rev_per_day</span> <span class="o">=</span> <span class="p">(</span><span class="n">orders_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">order_items_df</span><span class="p">,</span> <span class="n">orders_df</span><span class="o">.</span><span class="n">order_id</span> <span class="o">==</span> <span class="n">order_items_df</span><span class="o">.</span><span class="n">order_item_order_id</span><span class="p">)</span>
     <span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s1">&#39;order_date&#39;</span><span class="p">,</span> <span class="s1">&#39;order_item_subtotal&#39;</span><span class="p">,</span> <span class="s1">&#39;order_item_order_id&#39;</span><span class="p">])</span>
     <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s1">&#39;order_date&#39;</span><span class="p">)</span>
     <span class="o">.</span><span class="n">agg</span><span class="p">((</span><span class="n">F</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">&#39;order_item_subtotal&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">F</span><span class="o">.</span><span class="n">countDistinct</span><span class="p">(</span><span class="s1">&#39;order_item_order_id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;avg_rev_per_day&#39;</span><span class="p">))</span>
     <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s1">&#39;order_date&#39;</span><span class="p">))</span>

<span class="n">avg_rev_per_day</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[order_date: string, avg_rev_per_day: double]
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">avg_rev_per_day</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+---------------------+-----------------+
|order_date           |avg_rev_per_day  |
+---------------------+-----------------+
|2013-07-25 00:00:00.0|587.5330286848134|
|2013-07-26 00:00:00.0|585.9234878147109|
|2013-07-27 00:00:00.0|577.5676682063512|
|2013-07-28 00:00:00.0|551.4119109020958|
|2013-07-29 00:00:00.0|635.5883909684641|
|2013-07-30 00:00:00.0|564.5363838698838|
|2013-07-31 00:00:00.0|630.9955146643533|
|2013-08-01 00:00:00.0|608.4982189502356|
|2013-08-02 00:00:00.0|587.8871075517388|
|2013-08-03 00:00:00.0|599.1628419048382|
|2013-08-04 00:00:00.0|594.3201416863335|
|2013-08-05 00:00:00.0|592.8305590897799|
|2013-08-06 00:00:00.0|579.68106844792  |
|2013-08-07 00:00:00.0|583.906170096101 |
|2013-08-08 00:00:00.0|588.4743191939134|
|2013-08-09 00:00:00.0|629.4593056380147|
|2013-08-10 00:00:00.0|586.3113241756664|
|2013-08-11 00:00:00.0|551.5472206441007|
|2013-08-12 00:00:00.0|612.4790563343757|
|2013-08-13 00:00:00.0|604.1594044945457|
+---------------------+-----------------+
only showing top 20 rows
</pre></div>
</div>
<p>​</p>
</div>
<div class="section" id="get-average-revenue-per-month">
<h3>4.3.1 Get Average Revenue Per Month:<a class="headerlink" href="#get-average-revenue-per-month" title="Permalink to this headline">¶</a></h3>
<p><strong>DF API:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">avg_rev_per_month</span> <span class="o">=</span> <span class="p">(</span><span class="n">avg_rev_per_day</span>
                     <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">month</span><span class="p">(</span><span class="s1">&#39;order_date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">),</span> <span class="s1">&#39;avg_rev_per_day&#39;</span><span class="p">)</span>
                     <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">)</span>
                     <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">avg</span><span class="p">(</span><span class="s1">&#39;avg_rev_per_day&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;avg_rev_per_month&#39;</span><span class="p">))</span>
                     <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s1">&#39;month&#39;</span><span class="p">))</span>

<span class="n">avg_rev_per_month</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[month: int, avg_rev_per_month: double]
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">avg_rev_per_month</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-----+-----------------+
|month|avg_rev_per_month|
+-----+-----------------+
|1    |595.4252200140596|
|2    |594.3819554505748|
|3    |601.5593062028504|
|4    |594.360451299625 |
|5    |606.5245105647007|
|6    |611.6376611446879|
|7    |593.4468831474544|
|8    |597.588355427047 |
|9    |604.5177239484814|
|10   |590.8111000351574|
|11   |597.1851199455583|
|12   |596.4810251733772|
+-----+-----------------+
</pre></div>
</div>
<p>​</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">avg_rev_per_month</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Average Revenue Per Month&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p><img alt="png" src="../_images/output_63_01.png" /></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">avg_rev_per_month</span><span class="o">.</span><span class="n">unpersist</span><span class="p">()</span>
<span class="n">avg_rev_per_day</span><span class="o">.</span><span class="n">unpersist</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[month: int, avg_rev_per_month: double]






DataFrame[order_date: string, avg_rev_per_day: double]
</pre></div>
</div>
</div>
<div class="section" id="get-total-revenue-per-month-per-year">
<h3>4.3.2 Get Total Revenue Per Month Per Year:<a class="headerlink" href="#get-total-revenue-per-month-per-year" title="Permalink to this headline">¶</a></h3>
<p><strong>SQL:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;SELECT YEAR(o.order_date) as order_year, MONTH(o.order_date) as order_month, SUM(oi.order_item_subtotal) tot_revenue </span>
<span class="sd">          |FROM orders o JOIN order_items oi </span>
<span class="sd">          |    ON o.order_id = oi.order_item_order_id</span>
<span class="sd">          |GROUP BY order_year, order_month </span>
<span class="sd">          |ORDER BY order_year, order_month</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+----------+-----------+------------------+
|order_year|order_month|tot_revenue       |
+----------+-----------+------------------+
|2013      |7          |764782.2047252655 |
|2013      |8          |2828658.754573822 |
|2013      |9          |2934527.3265972137|
|2013      |10         |2624600.6605644226|
|2013      |11         |3168656.0921707153|
|2013      |12         |2932964.327445984 |
|2014      |1          |2924447.0670757294|
|2014      |2          |2778663.7149181366|
|2014      |3          |2862492.265932083 |
|2014      |4          |2807789.8547916412|
|2014      |5          |2753078.2738227844|
|2014      |6          |2703463.491306305 |
|2014      |7          |2238496.5645008087|
+----------+-----------+------------------+
</pre></div>
</div>
<p>​</p>
<p><strong>DF API:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tot_rev_per_month_per_year</span> <span class="o">=</span> <span class="p">(</span><span class="n">orders_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">order_items_df</span><span class="p">,</span> <span class="n">orders_df</span><span class="o">.</span><span class="n">order_id</span> <span class="o">==</span> <span class="n">order_items_df</span><span class="o">.</span><span class="n">order_item_order_id</span><span class="p">)</span>
     <span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">F</span><span class="o">.</span><span class="n">year</span><span class="p">(</span><span class="s1">&#39;order_date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;order_year&#39;</span><span class="p">),</span> <span class="n">F</span><span class="o">.</span><span class="n">month</span><span class="p">(</span><span class="s1">&#39;order_date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;order_month&#39;</span><span class="p">),</span> <span class="s1">&#39;order_item_subtotal&#39;</span><span class="p">])</span>
     <span class="o">.</span><span class="n">groupBy</span><span class="p">([</span><span class="s1">&#39;order_year&#39;</span><span class="p">,</span> <span class="s1">&#39;order_month&#39;</span><span class="p">])</span>
     <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">&#39;order_item_subtotal&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;tot_revenue&#39;</span><span class="p">))</span>
     <span class="o">.</span><span class="n">orderBy</span><span class="p">([</span><span class="s1">&#39;order_year&#39;</span><span class="p">,</span> <span class="s1">&#39;order_month&#39;</span><span class="p">]))</span>

<span class="n">tot_rev_per_month_per_year</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[order_year: int, order_month: int, tot_revenue: double]
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tot_rev_per_month_per_year</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+----------+-----------+------------------+
|order_year|order_month|       tot_revenue|
+----------+-----------+------------------+
|      2013|          7| 764782.2047252655|
|      2013|          8| 2828658.754573822|
|      2013|          9|2934527.3265972137|
|      2013|         10|2624600.6605644226|
|      2013|         11|3168656.0921707153|
|      2013|         12| 2932964.327445984|
|      2014|          1|2924447.0670757294|
|      2014|          2|2778663.7149181366|
|      2014|          3| 2862492.265932083|
|      2014|          4|2807789.8547916412|
|      2014|          5|2753078.2738227844|
|      2014|          6| 2703463.491306305|
|      2014|          7|2238496.5645008087|
+----------+-----------+------------------+
</pre></div>
</div>
<p>​</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pdf</span> <span class="o">=</span> <span class="n">tot_rev_per_month_per_year</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;order_month&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;tot_revenue&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;order_year&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">pdf</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Total Revenue Per Month Per Year&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p><img alt="png" src="../_images/output_72_0.png" /></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tot_rev_per_month_per_year</span><span class="o">.</span><span class="n">unpersist</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[order_year: int, order_month: int, tot_revenue: double]
</pre></div>
</div>
</div>
<div class="section" id="group-revenues-per-month-per-year">
<h3>4.4 Group Revenues per Month per Year:<a class="headerlink" href="#group-revenues-per-month-per-year" title="Permalink to this headline">¶</a></h3>
<p>The idea is taken from the book <a class="reference external" href="http://shop.oreilly.com/product/0636920034957.do">Spark: The Definitive Guide</a> We have seen simple group-by expressions that we can use to aggregate on a set of columns with the values in those columns. However, sometimes we want something a bit more complete - an aggregation across multiple groups. We achieve this by using <code class="docutils literal notranslate"><span class="pre">grouping</span> <span class="pre">sets</span></code></p>
<p><strong>SQL:</strong></p>
<p>When we want to do traditional sum of revenues per month per year we can achieve the same using <code class="docutils literal notranslate"><span class="pre">grouping</span> <span class="pre">sets</span></code> as well besides the traditional <code class="docutils literal notranslate"><span class="pre">group</span> <span class="pre">by</span></code> as shown below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;SELECT YEAR(o.order_date) as order_year, MONTH(o.order_date) as order_month, CAST(SUM(oi.order_item_subtotal) AS DECIMAL(38,2)) as tot_revenue </span>
<span class="sd">          |FROM orders o JOIN order_items oi </span>
<span class="sd">          |    ON o.order_id = oi.order_item_order_id</span>
<span class="sd">          |GROUP BY order_year, order_month GROUPING SETS((order_year, order_month))</span>
<span class="sd">          |ORDER BY order_year, order_month</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+----------+-----------+-----------+
|order_year|order_month|tot_revenue|
+----------+-----------+-----------+
|      2013|          7|  764782.20|
|      2013|          8| 2828658.75|
|      2013|          9| 2934527.33|
|      2013|         10| 2624600.66|
|      2013|         11| 3168656.09|
|      2013|         12| 2932964.33|
|      2014|          1| 2924447.07|
|      2014|          2| 2778663.71|
|      2014|          3| 2862492.27|
|      2014|          4| 2807789.85|
|      2014|          5| 2753078.27|
|      2014|          6| 2703463.49|
|      2014|          7| 2238496.56|
+----------+-----------+-----------+
</pre></div>
</div>
<p>​</p>
<p>Simple enough, but what if we also want to include the total revenue irrespective of the <code class="docutils literal notranslate"><span class="pre">order_month</span></code> and the <code class="docutils literal notranslate"><span class="pre">order_year</span></code> in the same result? With a conventional group-by statement, this would be impossible. But it’s simple with <code class="docutils literal notranslate"><span class="pre">grouping</span> <span class="pre">sets</span></code>: we simply specify that we would like to aggregate at that level, as well in our grouping set. This is, effectively, the union of several different groupings together.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;SELECT YEAR(o.order_date) as order_year, MONTH(o.order_date) as order_month, CAST(SUM(oi.order_item_subtotal) AS DECIMAL(38,2)) as tot_revenue </span>
<span class="sd">          |FROM orders o JOIN order_items oi </span>
<span class="sd">          |    ON o.order_id = oi.order_item_order_id</span>
<span class="sd">          |GROUP BY order_year, order_month GROUPING SETS((order_year, order_month),())</span>
<span class="sd">          |ORDER BY order_year, order_month</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+----------+-----------+-----------+
|order_year|order_month|tot_revenue|
+----------+-----------+-----------+
|      null|       null|34322620.60|
|      2013|          7|  764782.20|
|      2013|          8| 2828658.75|
|      2013|          9| 2934527.33|
|      2013|         10| 2624600.66|
|      2013|         11| 3168656.09|
|      2013|         12| 2932964.33|
|      2014|          1| 2924447.07|
|      2014|          2| 2778663.71|
|      2014|          3| 2862492.27|
|      2014|          4| 2807789.85|
|      2014|          5| 2753078.27|
|      2014|          6| 2703463.49|
|      2014|          7| 2238496.56|
+----------+-----------+-----------+
</pre></div>
</div>
<p>​</p>
<p>Here, include the following groupings in the same result:</p>
<ul class="simple">
<li><p>total revenue irrespective of the <code class="docutils literal notranslate"><span class="pre">order_year</span></code> and <code class="docutils literal notranslate"><span class="pre">order_month</span></code></p></li>
<li><p>total revenue per <code class="docutils literal notranslate"><span class="pre">order_year</span></code>  irrespective of the <code class="docutils literal notranslate"><span class="pre">order_month</span></code></p></li>
<li><p>total revenue per <code class="docutils literal notranslate"><span class="pre">order_month</span></code> irrespective of the <code class="docutils literal notranslate"><span class="pre">order_year</span></code></p></li>
<li><p>total revenue per <code class="docutils literal notranslate"><span class="pre">order_year</span></code>  per <code class="docutils literal notranslate"><span class="pre">order_month</span></code></p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;SELECT YEAR(o.order_date) as order_year, MONTH(o.order_date) as order_month, CAST(SUM(oi.order_item_subtotal) AS DECIMAL(38,2)) as tot_revenue  </span>
<span class="sd">          |FROM orders o JOIN order_items oi </span>
<span class="sd">          |    ON o.order_id = oi.order_item_order_id</span>
<span class="sd">          |GROUP BY order_year, order_month GROUPING SETS((order_year, order_month), (order_year), (order_month), ())</span>
<span class="sd">          |ORDER BY order_year, order_month</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+----------+-----------+-----------+
|order_year|order_month|tot_revenue|
+----------+-----------+-----------+
|      null|       null|34322620.60|
|      null|          1| 2924447.07|
|      null|          2| 2778663.71|
|      null|          3| 2862492.27|
|      null|          4| 2807789.85|
|      null|          5| 2753078.27|
|      null|          6| 2703463.49|
|      null|          7| 3003278.77|
|      null|          8| 2828658.75|
|      null|          9| 2934527.33|
|      null|         10| 2624600.66|
|      null|         11| 3168656.09|
|      null|         12| 2932964.33|
|      2013|       null|15254189.37|
|      2013|          7|  764782.20|
|      2013|          8| 2828658.75|
|      2013|          9| 2934527.33|
|      2013|         10| 2624600.66|
|      2013|         11| 3168656.09|
|      2013|         12| 2932964.33|
|      2014|       null|19068431.23|
|      2014|          1| 2924447.07|
|      2014|          2| 2778663.71|
|      2014|          3| 2862492.27|
|      2014|          4| 2807789.85|
|      2014|          5| 2753078.27|
|      2014|          6| 2703463.49|
|      2014|          7| 2238496.56|
+----------+-----------+-----------+
</pre></div>
</div>
<p>​</p>
<p><strong>DF API:</strong>
The GROUPING SETS operator is only available in SQL. To perform the same in DataFrames, we need to use the <code class="docutils literal notranslate"><span class="pre">rollup</span></code> and <code class="docutils literal notranslate"><span class="pre">cube</span></code> operators - which allow us to get the same results.</p>
<p>Let’s first get all the sales.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rev_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">orders_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">order_items_df</span><span class="p">,</span> <span class="n">orders_df</span><span class="o">.</span><span class="n">order_id</span> <span class="o">==</span> <span class="n">order_items_df</span><span class="o">.</span><span class="n">order_item_order_id</span><span class="p">)</span>
     <span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">F</span><span class="o">.</span><span class="n">year</span><span class="p">(</span><span class="s1">&#39;order_date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;order_year&#39;</span><span class="p">),</span> <span class="n">F</span><span class="o">.</span><span class="n">month</span><span class="p">(</span><span class="s1">&#39;order_date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;order_month&#39;</span><span class="p">),</span> <span class="s1">&#39;order_item_subtotal&#39;</span><span class="p">]))</span>

<span class="n">rev_df</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[order_year: int, order_month: int, order_item_subtotal: float]
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rev_df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+----------+-----------+-------------------+
|order_year|order_month|order_item_subtotal|
+----------+-----------+-------------------+
|2013      |7          |299.98             |
|2013      |7          |199.99             |
|2013      |7          |250.0              |
|2013      |7          |129.99             |
|2013      |7          |49.98              |
|2013      |7          |299.95             |
|2013      |7          |150.0              |
|2013      |7          |199.92             |
|2013      |7          |299.98             |
|2013      |7          |299.95             |
|2013      |7          |99.96              |
|2013      |7          |299.98             |
|2013      |7          |129.99             |
|2013      |7          |199.99             |
|2013      |7          |299.98             |
|2013      |7          |79.95              |
|2013      |7          |179.97             |
|2013      |7          |299.95             |
|2013      |7          |199.92             |
|2013      |7          |50.0               |
+----------+-----------+-------------------+
only showing top 20 rows
</pre></div>
</div>
<p>​</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pdf</span> <span class="o">=</span> <span class="n">rev_df</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;order_month&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;order_item_subtotal&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;order_year&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">pdf</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Distribution of Revenue Per Month for 2013&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p><img alt="png" src="../_images/output_86_0.png" /></p>
<p><strong>Rollups:</strong>
A <code class="docutils literal notranslate"><span class="pre">rollup</span></code> is a multidimensional aggregation that performs a variety of group-by style calculation for us. When we do a <code class="docutils literal notranslate"><span class="pre">rollup</span></code> based on <code class="docutils literal notranslate"><span class="pre">order_year</span></code> and <code class="docutils literal notranslate"><span class="pre">order_month</span></code> then we get the following multidimensional aggregations:</p>
<ul class="simple">
<li><p>total revenue irrespective of the <code class="docutils literal notranslate"><span class="pre">order_year</span></code> and <code class="docutils literal notranslate"><span class="pre">order_month</span></code></p></li>
<li><p>total revenue per <code class="docutils literal notranslate"><span class="pre">order_year</span></code>  irrespective of the <code class="docutils literal notranslate"><span class="pre">order_month</span></code></p></li>
<li><p>total revenue per <code class="docutils literal notranslate"><span class="pre">order_year</span></code>  per <code class="docutils literal notranslate"><span class="pre">order_month</span></code></p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">rev_df</span>
 <span class="o">.</span><span class="n">rollup</span><span class="p">(</span><span class="s2">&quot;order_year&quot;</span><span class="p">,</span> <span class="s2">&quot;order_month&quot;</span><span class="p">)</span>
 <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;order_item_subtotal&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">DecimalType</span><span class="p">(</span><span class="mi">38</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;tot_revenue&quot;</span><span class="p">))</span>
 <span class="o">.</span><span class="n">orderBy</span><span class="p">([</span><span class="s1">&#39;order_year&#39;</span><span class="p">,</span> <span class="s1">&#39;order_month&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+----------+-----------+-----------+
|order_year|order_month|tot_revenue|
+----------+-----------+-----------+
|      null|       null|34322620.60|
|      2013|       null|15254189.37|
|      2013|          7|  764782.20|
|      2013|          8| 2828658.75|
|      2013|          9| 2934527.33|
|      2013|         10| 2624600.66|
|      2013|         11| 3168656.09|
|      2013|         12| 2932964.33|
|      2014|       null|19068431.23|
|      2014|          1| 2924447.07|
|      2014|          2| 2778663.71|
|      2014|          3| 2862492.27|
|      2014|          4| 2807789.85|
|      2014|          5| 2753078.27|
|      2014|          6| 2703463.49|
|      2014|          7| 2238496.56|
+----------+-----------+-----------+
</pre></div>
</div>
<p>​</p>
<p><strong>Cube:</strong>
In <code class="docutils literal notranslate"><span class="pre">rollup</span></code> above we did not get the aggregation</p>
<ul class="simple">
<li><p>total revenue per <code class="docutils literal notranslate"><span class="pre">order_month</span></code> irrespective of the <code class="docutils literal notranslate"><span class="pre">order_year</span></code></p></li>
</ul>
<p>Rollup treats elements hierarchically and since <code class="docutils literal notranslate"><span class="pre">order_month</span></code> was the last element in the group-by clause so it is treated as the last level of hierarchy and hence to grouping was performed on <code class="docutils literal notranslate"><span class="pre">order_month</span></code> alone. We can use <code class="docutils literal notranslate"><span class="pre">cube</span></code> here. A <code class="docutils literal notranslate"><span class="pre">cube</span></code> takes the <code class="docutils literal notranslate"><span class="pre">rollup</span></code> to a level deeper. Rather than treating elements hierarchically, a cube does the same thing across all dimensions. This means it won’t just go by <code class="docutils literal notranslate"><span class="pre">order_year</span></code> over the entire time period, but also the <code class="docutils literal notranslate"><span class="pre">order_month</span></code>.</p>
<p>Using <code class="docutils literal notranslate"><span class="pre">cube</span></code> helps to answer all the of the following in one aggregate DataFrame.</p>
<ul class="simple">
<li><p>total revenue irrespective of the <code class="docutils literal notranslate"><span class="pre">order_year</span></code> and <code class="docutils literal notranslate"><span class="pre">order_month</span></code></p></li>
<li><p>total revenue per <code class="docutils literal notranslate"><span class="pre">order_year</span></code>  irrespective of the <code class="docutils literal notranslate"><span class="pre">order_month</span></code></p></li>
<li><p>total revenue per <code class="docutils literal notranslate"><span class="pre">order_month</span></code> irrespective of the <code class="docutils literal notranslate"><span class="pre">order_year</span></code></p></li>
<li><p>total revenue per <code class="docutils literal notranslate"><span class="pre">order_year</span></code>  per <code class="docutils literal notranslate"><span class="pre">order_month</span></code></p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">rev_df</span>
 <span class="o">.</span><span class="n">cube</span><span class="p">(</span><span class="s2">&quot;order_year&quot;</span><span class="p">,</span> <span class="s2">&quot;order_month&quot;</span><span class="p">)</span>
 <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;order_item_subtotal&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;total_sales&quot;</span><span class="p">))</span>
 <span class="o">.</span><span class="n">orderBy</span><span class="p">([</span><span class="s1">&#39;order_year&#39;</span><span class="p">,</span> <span class="s1">&#39;order_month&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+----------+-----------+--------------------+
|order_year|order_month|         total_sales|
+----------+-----------+--------------------+
|      null|       null| 3.432262059842491E7|
|      null|          1|  2924447.0670757294|
|      null|          2|  2778663.7149181366|
|      null|          3|   2862492.265932083|
|      null|          4|  2807789.8547916412|
|      null|          5|  2753078.2738227844|
|      null|          6|   2703463.491306305|
|      null|          7|   3003278.769226074|
|      null|          8|   2828658.754573822|
|      null|          9|  2934527.3265972137|
|      null|         10|  2624600.6605644226|
|      null|         11|  3168656.0921707153|
|      null|         12|   2932964.327445984|
|      2013|       null|1.5254189366077423E7|
|      2013|          7|   764782.2047252655|
|      2013|          8|   2828658.754573822|
|      2013|          9|  2934527.3265972137|
|      2013|         10|  2624600.6605644226|
|      2013|         11|  3168656.0921707153|
|      2013|         12|   2932964.327445984|
|      2014|       null| 1.906843123234749E7|
|      2014|          1|  2924447.0670757294|
|      2014|          2|  2778663.7149181366|
|      2014|          3|   2862492.265932083|
|      2014|          4|  2807789.8547916412|
|      2014|          5|  2753078.2738227844|
|      2014|          6|   2703463.491306305|
|      2014|          7|  2238496.5645008087|
+----------+-----------+--------------------+
</pre></div>
</div>
<p>​</p>
<p><a class="reference external" href="#Table-of-contents">Back to Top</a></p>
</div>
<div class="section" id="top-performing-departments">
<h3>4.5 Top Performing Departments:<a class="headerlink" href="#top-performing-departments" title="Permalink to this headline">¶</a></h3>
<p><strong>SQL:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;SELECT d.department_name, YEAR(o.order_date) as order_year, SUM(oi.order_item_subtotal) as tot_revenue</span>
<span class="sd">          |FROM orders o </span>
<span class="sd">          |    INNER JOIN order_items oi </span>
<span class="sd">          |        ON o.order_id = oi.order_item_order_id</span>
<span class="sd">          |    INNER JOIN products p</span>
<span class="sd">          |        ON oi.order_item_product_id = p.product_id</span>
<span class="sd">          |    INNER JOIN categories c</span>
<span class="sd">          |        ON c.category_id = p.product_category_id</span>
<span class="sd">          |    INNER JOIN departments d</span>
<span class="sd">          |        ON c.category_department_id = d.department_id</span>
<span class="sd">          |WHERE o.order_status &lt;&gt; &#39;CANCELED&#39; AND o.order_status &lt;&gt; &#39;SUSPECTED_FRAUD&#39;</span>
<span class="sd">          |GROUP BY d.department_name, order_year</span>
<span class="sd">          |ORDER BY d.department_name, order_year</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+---------------+----------+------------------+
|department_name|order_year|tot_revenue       |
+---------------+----------+------------------+
|Apparel        |2013      |3090985.6535224915|
|Apparel        |2014      |3917585.841217041 |
|Fan Shop       |2013      |7290831.879999161 |
|Fan Shop       |2014      |9095735.77280426  |
|Fitness        |2013      |119526.58082199097|
|Fitness        |2014      |150509.1409931183 |
|Footwear       |2013      |1711492.5186824799|
|Footwear       |2014      |2122339.649032593 |
|Golf           |2013      |1967396.959728241 |
|Golf           |2014      |2440585.2815055847|
|Outdoors       |2013      |420317.9507675171 |
|Outdoors       |2014      |532437.6709976196 |
+---------------+----------+------------------+
</pre></div>
</div>
<p>​</p>
<p><strong>DF API:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">orders_df</span>
      <span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">orders_df</span><span class="o">.</span><span class="n">order_status</span> <span class="o">!=</span> <span class="s1">&#39;CANCELED&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">orders_df</span><span class="o">.</span><span class="n">order_status</span> <span class="o">!=</span> <span class="s1">&#39;SUSPECTED_FRAUD&#39;</span><span class="p">))</span>
      <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">order_items_df</span><span class="p">,</span> <span class="n">orders_df</span><span class="o">.</span><span class="n">order_id</span> <span class="o">==</span> <span class="n">order_items_df</span><span class="o">.</span><span class="n">order_item_order_id</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
      <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">products_df</span><span class="p">,</span> <span class="n">order_items_df</span><span class="o">.</span><span class="n">order_item_product_id</span> <span class="o">==</span> <span class="n">products_df</span><span class="o">.</span><span class="n">product_id</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
      <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">categories_df</span><span class="p">,</span> <span class="n">products_df</span><span class="o">.</span><span class="n">product_category_id</span> <span class="o">==</span> <span class="n">categories_df</span><span class="o">.</span><span class="n">category_id</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
      <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">departments_df</span><span class="p">,</span> <span class="n">categories_df</span><span class="o">.</span><span class="n">category_department_id</span> <span class="o">==</span> <span class="n">departments_df</span><span class="o">.</span><span class="n">department_id</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
      <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;department_name&#39;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">year</span><span class="p">(</span><span class="n">orders_df</span><span class="o">.</span><span class="n">order_date</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;order_year&#39;</span><span class="p">),</span> <span class="s1">&#39;order_item_subtotal&#39;</span><span class="p">)</span>
      <span class="o">.</span><span class="n">groupBy</span><span class="p">([</span><span class="n">departments_df</span><span class="o">.</span><span class="n">department_name</span><span class="p">,</span> <span class="s1">&#39;order_year&#39;</span><span class="p">])</span>
      <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">order_items_df</span><span class="o">.</span><span class="n">order_item_subtotal</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;tot_revenue&#39;</span><span class="p">))</span>
      <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s1">&#39;department_name&#39;</span><span class="p">,</span> <span class="s1">&#39;order_year&#39;</span><span class="p">))</span>
<span class="n">df</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[department_name: string, order_year: int, tot_revenue: double]
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+---------------+----------+------------------+
|department_name|order_year|       tot_revenue|
+---------------+----------+------------------+
|        Apparel|      2013|3090985.6535224915|
|        Apparel|      2014| 3917585.841217041|
|       Fan Shop|      2013| 7290831.879999161|
|       Fan Shop|      2014|  9095735.77280426|
|        Fitness|      2013|119526.58082199097|
|        Fitness|      2014| 150509.1409931183|
|       Footwear|      2013|1711492.5186824799|
|       Footwear|      2014| 2122339.649032593|
|           Golf|      2013| 1967396.959728241|
|           Golf|      2014|2440585.2815055847|
|       Outdoors|      2013| 420317.9507675171|
|       Outdoors|      2014| 532437.6709976196|
+---------------+----------+------------------+
</pre></div>
</div>
<p>​</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pdf</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pdf</span> <span class="o">=</span> <span class="n">pdf</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;department_name&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;order_year&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;tot_revenue&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>order_year               2013          2014
department_name                            
Apparel          3.090986e+06  3.917586e+06
Fan Shop         7.290832e+06  9.095736e+06
Fitness          1.195266e+05  1.505091e+05
Footwear         1.711493e+06  2.122340e+06
Golf             1.967397e+06  2.440585e+06
Outdoors         4.203180e+05  5.324377e+05
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pdf</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Top Performing Departments&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p><img alt="png" src="../_images/output_101_0.png" /></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">unpersist</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[department_name: string, order_year: int, tot_revenue: double]
</pre></div>
</div>
<p><a class="reference external" href="#Table-of-contents">Back to Top</a></p>
</div>
<div class="section" id="get-highest-priced-product">
<h3>4.6 Get Highest Priced Product:<a class="headerlink" href="#get-highest-priced-product" title="Permalink to this headline">¶</a></h3>
<p><strong>SQL:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;SELECT p.* </span>
<span class="sd">          |FROM products p</span>
<span class="sd">          |WHERE p.product_price = (SELECT MAX(q.product_price) FROM products q)</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+----------+-------------------+-------------------+-------------------+-------------+--------------------+
|product_id|product_category_id|       product_name|product_description|product_price|       product_image|
+----------+-------------------+-------------------+-------------------+-------------+--------------------+
|       208|                 10|SOLE E35 Elliptical|               null|      1999.99|http://images.acm...|
+----------+-------------------+-------------------+-------------------+-------------+--------------------+
</pre></div>
</div>
<p>​</p>
<p><strong>SQL Using rank() Window Function:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;SELECT * </span>
<span class="sd">          |FROM ( </span>
<span class="sd">          |    SELECT *, </span>
<span class="sd">          |         RANK() OVER (ORDER BY product_price DESC) as rank</span>
<span class="sd">          |    FROM products) tmp</span>
<span class="sd">          |WHERE rank &lt;= 1</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+----------+-------------------+-------------------+-------------------+-------------+--------------------+----+
|product_id|product_category_id|       product_name|product_description|product_price|       product_image|rank|
+----------+-------------------+-------------------+-------------------+-------------+--------------------+----+
|       208|                 10|SOLE E35 Elliptical|               null|      1999.99|http://images.acm...|   1|
+----------+-------------------+-------------------+-------------------+-------------+--------------------+----+
</pre></div>
</div>
<p>​</p>
<p><strong>DF API:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">products_df</span>
 <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
 <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;product_price&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">products_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="s1">&#39;product_price&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
 <span class="o">.</span><span class="n">show</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+----------+-------------------+-------------------+-------------------+-------------+--------------------+
|product_id|product_category_id|       product_name|product_description|product_price|       product_image|
+----------+-------------------+-------------------+-------------------+-------------+--------------------+
|       208|                 10|SOLE E35 Elliptical|               null|      1999.99|http://images.acm...|
+----------+-------------------+-------------------+-------------------+-------------+--------------------+
</pre></div>
</div>
<p>​</p>
<p><strong>DF API Using Window Function:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">windowSpec</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">products_df</span><span class="p">[</span><span class="s1">&#39;product_price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">products_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">rank</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">windowSpec</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;rank&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;rank&#39;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+----------+-------------------+-------------------+-------------------+-------------+--------------------+----+
|product_id|product_category_id|       product_name|product_description|product_price|       product_image|rank|
+----------+-------------------+-------------------+-------------------+-------------+--------------------+----+
|       208|                 10|SOLE E35 Elliptical|               null|      1999.99|http://images.acm...|   1|
+----------+-------------------+-------------------+-------------------+-------------+--------------------+----+
</pre></div>
</div>
<p>​</p>
<p><a class="reference external" href="#Table-of-contents">Back to Top</a></p>
</div>
<div class="section" id="get-highest-revenue-earning-products">
<h3>4.7 Get Highest Revenue Earning Products:<a class="headerlink" href="#get-highest-revenue-earning-products" title="Permalink to this headline">¶</a></h3>
<p><strong>SQL:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;SELECT p.*, r.product_revenue</span>
<span class="sd">          |FROM products p, (SELECT oi.order_item_product_id, SUM(CAST(oi.order_item_subtotal as float)) as product_revenue</span>
<span class="sd">          |                    FROM order_items oi </span>
<span class="sd">          |                    GROUP BY order_item_product_id </span>
<span class="sd">          |                    ORDER BY product_revenue DESC </span>
<span class="sd">          |                    LIMIT 1) r</span>
<span class="sd">          |WHERE product_id = r.order_item_product_id</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+----------+-------------------+--------------------+-------------------+-------------+--------------------+-----------------+
|product_id|product_category_id|        product_name|product_description|product_price|       product_image|  product_revenue|
+----------+-------------------+--------------------+-------------------+-------------+--------------------+-----------------+
|      1004|                 45|Field &amp; Stream Sp...|               null|       399.98|http://images.acm...|6929653.690338135|
+----------+-------------------+--------------------+-------------------+-------------+--------------------+-----------------+
</pre></div>
</div>
<p>​</p>
<p><strong>SQL:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Top 10 revenue generating products (another way of doing similar thing as above)</span>
<span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;SELECT p.product_id, p.product_category_id, p.product_name, r.product_revenue</span>
<span class="sd">          |FROM products p INNER JOIN</span>
<span class="sd">          |                    (SELECT oi.order_item_product_id, round(SUM(CAST(oi.order_item_subtotal as float)), 2) as product_revenue</span>
<span class="sd">          |                     FROM order_items oi INNER JOIN orders o </span>
<span class="sd">          |                         ON oi.order_item_order_id = o.order_id</span>
<span class="sd">          |                     WHERE o.order_status &lt;&gt; &#39;CANCELED&#39;</span>
<span class="sd">          |                     AND o.order_status &lt;&gt; &#39;SUSPECTED_FRAUD&#39;</span>
<span class="sd">          |                     GROUP BY oi.order_item_product_id) r</span>
<span class="sd">          |ON p.product_id = r.order_item_product_id</span>
<span class="sd">          |ORDER BY r.product_revenue DESC</span>
<span class="sd">          |LIMIT 10</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+----------+-------------------+---------------------------------------------+---------------+
|product_id|product_category_id|product_name                                 |product_revenue|
+----------+-------------------+---------------------------------------------+---------------+
|1004      |45                 |Field &amp; Stream Sportsman 16 Gun Fire Safe    |6637668.28     |
|365       |17                 |Perfect Fitness Perfect Rip Deck             |4233794.37     |
|957       |43                 |Diamondback Women&#39;s Serene Classic Comfort Bi|3946837.0      |
|191       |9                  |Nike Men&#39;s Free 5.0+ Running Shoe            |3507549.21     |
|502       |24                 |Nike Men&#39;s Dri-FIT Victory Golf Polo         |3011600.0      |
|1073      |48                 |Pelican Sunstream 100 Kayak                  |2967851.68     |
|1014      |46                 |O&#39;Brien Men&#39;s Neoprene Life Vest             |2765543.31     |
|403       |18                 |Nike Men&#39;s CJ Elite 2 TD Football Cleat      |2763977.49     |
|627       |29                 |Under Armour Girls&#39; Toddler Spine Surge Runni|1214896.22     |
|565       |26                 |adidas Youth Germany Black/Red Away Match Soc|63490.0        |
+----------+-------------------+---------------------------------------------+---------------+
</pre></div>
</div>
<p>​</p>
<p><strong>DF API:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. Get the sum of revenue of all the products grouped by order_item_product_id from order_items table</span>
<span class="c1"># 2. Sort the result in descending order of their revenues</span>
<span class="c1"># 3. Take only the first one from the sorted order using the limit() function</span>
<span class="c1"># 4. Join with the prorcuts column to get the product details</span>
<span class="p">(</span><span class="n">order_items_df</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s1">&#39;order_item_product_id&#39;</span><span class="p">,</span> <span class="s1">&#39;order_item_subtotal&#39;</span><span class="p">])</span>
     <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s1">&#39;order_item_product_id&#39;</span><span class="p">)</span>
     <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">&#39;order_item_subtotal&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;product_revenue&#39;</span><span class="p">))</span>
     <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s1">&#39;product_revenue&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
     <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
     <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">products_df</span><span class="p">,</span> <span class="n">order_items_df</span><span class="o">.</span><span class="n">order_item_product_id</span> <span class="o">==</span> <span class="n">products_df</span><span class="o">.</span><span class="n">product_id</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
     <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;product_id&#39;</span><span class="p">,</span> <span class="s1">&#39;product_category_id&#39;</span><span class="p">,</span> <span class="s1">&#39;product_name&#39;</span><span class="p">,</span> <span class="s1">&#39;product_revenue&#39;</span><span class="p">)</span>
     <span class="o">.</span><span class="n">show</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+----------+-------------------+--------------------+-----------------+
|product_id|product_category_id|        product_name|  product_revenue|
+----------+-------------------+--------------------+-----------------+
|      1004|                 45|Field &amp; Stream Sp...|6929653.690338135|
+----------+-------------------+--------------------+-----------------+
</pre></div>
</div>
<p>​</p>
<p><a class="reference external" href="#Table-of-contents">Back to Top</a></p>
</div>
<div class="section" id="top-5-highest-revenue-earning-products-per-month-per-year">
<h3>4.8 Top 5 Highest Revenue Earning Products Per Month Per Year:<a class="headerlink" href="#top-5-highest-revenue-earning-products-per-month-per-year" title="Permalink to this headline">¶</a></h3>
<p><strong>SQL:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Map from month number to actual month string</span>
<span class="n">monthmap</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span><span class="s2">&quot;Jan&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="s2">&quot;Feb&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="s2">&quot;Mar&quot;</span><span class="p">,</span>  <span class="mi">4</span><span class="p">:</span><span class="s2">&quot;Apr&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span><span class="s2">&quot;May&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span><span class="s2">&quot;Jun&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">:</span><span class="s2">&quot;Jul&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">:</span><span class="s2">&quot;Aug&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">:</span><span class="s2">&quot;Sep&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span><span class="s2">&quot;Oct&quot;</span><span class="p">,</span> <span class="mi">11</span><span class="p">:</span><span class="s2">&quot;Nov&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span><span class="s2">&quot;Dec&quot;</span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in order to use an udf with sql it needs to be registerd to sqlContext</span>
<span class="n">sqlContext</span><span class="o">.</span><span class="n">udf</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;udfmonTomonth&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">monthmap</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">StringType</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;function __main__.&lt;lambda&gt;&gt;
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;SELECT q.* </span>
<span class="sd">          |FROM (</span>
<span class="sd">          |     SELECT r.*, DENSE_RANK() OVER (PARTITION by order_year, order_month ORDER BY product_revenue DESC) as dense_rank</span>
<span class="sd">          |     FROM (</span>
<span class="sd">          |          SELECT YEAR(o.order_date) as order_year, udfmonTomonth(MONTH(o.order_date)) as order_month, p.product_name, ROUND(SUM(CAST(oi.order_item_subtotal as float)), 2) as product_revenue</span>
<span class="sd">          |          FROM order_items oi </span>
<span class="sd">          |              INNER JOIN orders o </span>
<span class="sd">          |                  ON oi.order_item_order_id = o.order_id</span>
<span class="sd">          |              INNER JOIN products p</span>
<span class="sd">          |                  ON oi.order_item_product_id = p.product_id</span>
<span class="sd">          |              WHERE o.order_status &lt;&gt; &#39;CANCELED&#39; AND o.order_status &lt;&gt; &#39;SUSPECTED_FRAUD&#39;</span>
<span class="sd">          |              GROUP BY order_year, order_month, p.product_name ) r ) q</span>
<span class="sd">          |WHERE q.dense_rank &lt;= 5</span>
<span class="sd">          |ORDER BY q.order_year, q.order_month, q.dense_rank</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">))</span>

<span class="n">df</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[order_year: int, order_month: string, product_name: string, product_revenue: double, dense_rank: int]
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+----------+-----------+---------------------------------------------+---------------+----------+
|order_year|order_month|product_name                                 |product_revenue|dense_rank|
+----------+-----------+---------------------------------------------+---------------+----------+
|2013      |Aug        |Field &amp; Stream Sportsman 16 Gun Fire Safe    |540772.97      |1         |
|2013      |Aug        |Perfect Fitness Perfect Rip Deck             |349861.69      |2         |
|2013      |Aug        |Diamondback Women&#39;s Serene Classic Comfort Bi|319778.69      |3         |
|2013      |Aug        |Nike Men&#39;s Free 5.0+ Running Shoe            |279172.08      |4         |
|2013      |Aug        |Nike Men&#39;s Dri-FIT Victory Golf Polo         |247700.0       |5         |
|2013      |Dec        |Field &amp; Stream Sportsman 16 Gun Fire Safe    |595570.24      |1         |
|2013      |Dec        |Perfect Fitness Perfect Rip Deck             |342842.86      |2         |
|2013      |Dec        |Diamondback Women&#39;s Serene Classic Comfort Bi|336277.59      |3         |
|2013      |Dec        |Nike Men&#39;s Free 5.0+ Running Shoe            |298370.16      |4         |
|2013      |Dec        |Pelican Sunstream 100 Kayak                  |249987.51      |5         |
|2013      |Jul        |Field &amp; Stream Sportsman 16 Gun Fire Safe    |150792.46      |1         |
|2013      |Jul        |Perfect Fitness Perfect Rip Deck             |98923.51       |2         |
|2013      |Jul        |Diamondback Women&#39;s Serene Classic Comfort Bi|92993.8        |3         |
|2013      |Jul        |Nike Men&#39;s Free 5.0+ Running Shoe            |77192.28       |4         |
|2013      |Jul        |Nike Men&#39;s Dri-FIT Victory Golf Polo         |64750.0        |5         |
|2013      |Nov        |Field &amp; Stream Sportsman 16 Gun Fire Safe    |605969.72      |1         |
|2013      |Nov        |Perfect Fitness Perfect Rip Deck             |384655.89      |2         |
|2013      |Nov        |Diamondback Women&#39;s Serene Classic Comfort Bi|375874.95      |3         |
|2013      |Nov        |Nike Men&#39;s Free 5.0+ Running Shoe            |328567.14      |4         |
|2013      |Nov        |Nike Men&#39;s Dri-FIT Victory Golf Polo         |278400.0       |5         |
+----------+-----------+---------------------------------------------+---------------+----------+
only showing top 20 rows
</pre></div>
</div>
<p>​</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pdf</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>For 2013:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;order_month&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;product_revenue&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;product_name&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">pdf</span><span class="p">[</span><span class="n">pdf</span><span class="p">[</span><span class="s1">&#39;order_year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2013</span><span class="p">])</span>
<span class="n">g</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 5 Highest Revenue Earning Products Per Month in 2013&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p><img alt="png" src="../_images/output_131_01.png" /></p>
<p><strong>For 2014:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;order_month&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;product_revenue&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;product_name&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">pdf</span><span class="p">[</span><span class="n">pdf</span><span class="p">[</span><span class="s1">&#39;order_year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2014</span><span class="p">]);</span>
<span class="n">g</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Top 5 Highest Revenue Earning Products Per Month in 2014&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p><img alt="png" src="../_images/output_133_0.png" /></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">unpersist</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[order_year: int, order_month: string, product_name: string, product_revenue: double, dense_rank: int]
</pre></div>
</div>
<p><strong>DF API:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define a udf</span>
<span class="n">udfmonTomonth</span> <span class="o">=</span> <span class="n">udf</span><span class="p">(</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">monthmap</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">StringType</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rev_per_month_per_year_per_product</span> <span class="o">=</span> <span class="p">(</span><span class="n">orders_df</span>
                         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">year</span><span class="p">(</span><span class="s1">&#39;order_date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;order_year&#39;</span><span class="p">),</span> <span class="n">udfmonTomonth</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">month</span><span class="p">(</span><span class="s1">&#39;order_date&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;order_month&#39;</span><span class="p">),</span> <span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="s1">&#39;order_status&#39;</span><span class="p">)</span>
                         <span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;order_status&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;CANCELED&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;order_status&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;SUSPECTED_FRAUD&#39;</span><span class="p">))</span>
                         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">order_items_df</span><span class="p">,</span> <span class="n">orders_df</span><span class="o">.</span><span class="n">order_id</span> <span class="o">==</span> <span class="n">order_items_df</span><span class="o">.</span><span class="n">order_item_order_id</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
                         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">products_df</span><span class="p">,</span> <span class="n">order_items_df</span><span class="o">.</span><span class="n">order_item_product_id</span> <span class="o">==</span> <span class="n">products_df</span><span class="o">.</span><span class="n">product_id</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
                         <span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s1">&#39;order_year&#39;</span><span class="p">,</span> <span class="s1">&#39;order_month&#39;</span><span class="p">,</span> <span class="s1">&#39;product_name&#39;</span><span class="p">,</span> <span class="s1">&#39;order_item_subtotal&#39;</span><span class="p">])</span>
                         <span class="o">.</span><span class="n">groupBy</span><span class="p">([</span><span class="s1">&#39;order_year&#39;</span><span class="p">,</span> <span class="s1">&#39;order_month&#39;</span><span class="p">,</span> <span class="s1">&#39;product_name&#39;</span><span class="p">])</span>
                         <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">&#39;order_item_subtotal&#39;</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;product_revenue&#39;</span><span class="p">)))</span>

<span class="n">rev_per_month_per_year_per_product</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[order_year: int, order_month: string, product_name: string, product_revenue: double]
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rev_per_month_per_year_per_product</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+----------+-----------+---------------------------------------------+---------------+
|order_year|order_month|product_name                                 |product_revenue|
+----------+-----------+---------------------------------------------+---------------+
|2013      |Nov        |Under Armour Women&#39;s Micro G Skulpt Running S|3792.93        |
|2013      |Oct        |Polar Loop Activity Tracker                  |329.85         |
|2014      |Jan        |Bushnell Pro X7 Jolt Slope Rangefinder       |599.99         |
|2013      |Aug        |Hirzl Men&#39;s Hybrid Golf Glove                |1064.29        |
|2014      |Feb        |Titleist Small Wheeled Travel Cover          |249.99         |
+----------+-----------+---------------------------------------------+---------------+
only showing top 5 rows
</pre></div>
</div>
<p>​</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">windowSpec</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">([</span><span class="n">rev_per_month_per_year_per_product</span><span class="o">.</span><span class="n">order_year</span><span class="p">,</span> <span class="n">rev_per_month_per_year_per_product</span><span class="o">.</span><span class="n">order_month</span><span class="p">])</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">rev_per_month_per_year_per_product</span><span class="p">[</span><span class="s1">&#39;product_revenue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">top_prod_per_month_per_year_by_rev</span> <span class="o">=</span> <span class="p">(</span><span class="n">rev_per_month_per_year_per_product</span>
                           <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">dense_rank</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">windowSpec</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;dense_rank&#39;</span><span class="p">))</span>
                           <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;dense_rank&#39;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span>
                           <span class="o">.</span><span class="n">orderBy</span><span class="p">([</span><span class="s1">&#39;order_year&#39;</span><span class="p">,</span> <span class="s1">&#39;order_month&#39;</span><span class="p">,</span> <span class="s1">&#39;dense_rank&#39;</span><span class="p">]))</span>

<span class="n">top_prod_per_month_per_year_by_rev</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[order_year: int, order_month: string, product_name: string, product_revenue: double, dense_rank: int]
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">top_prod_per_month_per_year_by_rev</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+----------+-----------+---------------------------------------------+---------------+----------+
|order_year|order_month|product_name                                 |product_revenue|dense_rank|
+----------+-----------+---------------------------------------------+---------------+----------+
|2013      |Aug        |Field &amp; Stream Sportsman 16 Gun Fire Safe    |540772.97      |1         |
|2013      |Aug        |Perfect Fitness Perfect Rip Deck             |349861.69      |2         |
|2013      |Aug        |Diamondback Women&#39;s Serene Classic Comfort Bi|319778.69      |3         |
|2013      |Aug        |Nike Men&#39;s Free 5.0+ Running Shoe            |279172.08      |4         |
|2013      |Aug        |Nike Men&#39;s Dri-FIT Victory Golf Polo         |247700.0       |5         |
|2013      |Dec        |Field &amp; Stream Sportsman 16 Gun Fire Safe    |595570.24      |1         |
|2013      |Dec        |Perfect Fitness Perfect Rip Deck             |342842.86      |2         |
|2013      |Dec        |Diamondback Women&#39;s Serene Classic Comfort Bi|336277.59      |3         |
|2013      |Dec        |Nike Men&#39;s Free 5.0+ Running Shoe            |298370.16      |4         |
|2013      |Dec        |Pelican Sunstream 100 Kayak                  |249987.51      |5         |
|2013      |Jul        |Field &amp; Stream Sportsman 16 Gun Fire Safe    |150792.46      |1         |
|2013      |Jul        |Perfect Fitness Perfect Rip Deck             |98923.51       |2         |
|2013      |Jul        |Diamondback Women&#39;s Serene Classic Comfort Bi|92993.8        |3         |
|2013      |Jul        |Nike Men&#39;s Free 5.0+ Running Shoe            |77192.28       |4         |
|2013      |Jul        |Nike Men&#39;s Dri-FIT Victory Golf Polo         |64750.0        |5         |
|2013      |Nov        |Field &amp; Stream Sportsman 16 Gun Fire Safe    |605969.72      |1         |
|2013      |Nov        |Perfect Fitness Perfect Rip Deck             |384655.89      |2         |
|2013      |Nov        |Diamondback Women&#39;s Serene Classic Comfort Bi|375874.95      |3         |
|2013      |Nov        |Nike Men&#39;s Free 5.0+ Running Shoe            |328567.14      |4         |
|2013      |Nov        |Nike Men&#39;s Dri-FIT Victory Golf Polo         |278400.0       |5         |
+----------+-----------+---------------------------------------------+---------------+----------+
only showing top 20 rows
</pre></div>
</div>
<p>​</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rev_per_month_per_year_per_product</span><span class="o">.</span><span class="n">unpersist</span><span class="p">()</span>
<span class="n">top_prod_per_month_per_year_by_rev</span><span class="o">.</span><span class="n">unpersist</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[order_year: int, order_month: string, product_name: string, product_revenue: double]






DataFrame[order_year: int, order_month: string, product_name: string, product_revenue: double, dense_rank: int]
</pre></div>
</div>
<p><a class="reference external" href="#Table-of-contents">Back to Top</a></p>
</div>
<div class="section" id="get-the-most-popular-categories">
<h3>4.9 Get the most popular Categories:<a class="headerlink" href="#get-the-most-popular-categories" title="Permalink to this headline">¶</a></h3>
<p><strong>SQL:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;SELECT c.category_name, COUNT(order_item_quantity) as order_count </span>
<span class="sd">          |FROM order_items oi </span>
<span class="sd">          |INNER JOIN products p on oi.order_item_product_id = p.product_id </span>
<span class="sd">          |INNER JOIN categories c on c.category_id = p.product_category_id </span>
<span class="sd">          |GROUP BY c.category_name </span>
<span class="sd">          |ORDER BY order_count DESC </span>
<span class="sd">          |LIMIT 10 </span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+--------------------+-----------+
|       category_name|order_count|
+--------------------+-----------+
|              Cleats|      24551|
|      Men&#39;s Footwear|      22246|
|     Women&#39;s Apparel|      21035|
|Indoor/Outdoor Games|      19298|
|             Fishing|      17325|
|        Water Sports|      15540|
|    Camping &amp; Hiking|      13729|
|    Cardio Equipment|      12487|
|       Shop By Sport|      10984|
|         Electronics|       3156|
+--------------------+-----------+
</pre></div>
</div>
<p>​</p>
<p><strong>DF API:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pop_cat</span> <span class="o">=</span> <span class="p">(</span><span class="n">order_items_df</span>
 <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">products_df</span><span class="p">,</span> <span class="n">order_items_df</span><span class="o">.</span><span class="n">order_item_product_id</span> <span class="o">==</span> <span class="n">products_df</span><span class="o">.</span><span class="n">product_id</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
 <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">categories_df</span><span class="p">,</span> <span class="n">categories_df</span><span class="o">.</span><span class="n">category_id</span> <span class="o">==</span> <span class="n">products_df</span><span class="o">.</span><span class="n">product_category_id</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
 <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s1">&#39;category_name&#39;</span><span class="p">)</span>
 <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">&#39;order_item_quantity&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;order_count&#39;</span><span class="p">))</span>
 <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s1">&#39;order_count&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
 <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

<span class="n">pop_cat</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[category_name: string, order_count: bigint]
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pop_cat</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+--------------------+-----------+
|       category_name|order_count|
+--------------------+-----------+
|              Cleats|      73734|
|     Women&#39;s Apparel|      62956|
|Indoor/Outdoor Games|      57803|
|    Cardio Equipment|      37587|
|       Shop By Sport|      32726|
|      Men&#39;s Footwear|      22246|
|             Fishing|      17325|
|        Water Sports|      15540|
|    Camping &amp; Hiking|      13729|
|         Electronics|       9436|
+--------------------+-----------+
</pre></div>
</div>
<p>​</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pdf</span> <span class="o">=</span> <span class="n">pop_cat</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">pdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;pie&#39;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s1">&#39;order_count&#39;</span><span class="p">,</span> <span class="n">autopct</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%1.1f%%</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">startangle</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">pdf</span><span class="p">[</span><span class="s1">&#39;category_name&#39;</span><span class="p">],</span> 
          <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Most popular Categories&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">)));</span>
</pre></div>
</div>
<p><img alt="png" src="../_images/output_151_0.png" /></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pop_cat</span><span class="o">.</span><span class="n">unpersist</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[category_name: string, order_count: bigint]
</pre></div>
</div>
<p><a class="reference external" href="#Table-of-contents">Back to Top</a></p>
</div>
<div class="section" id="get-the-revenue-for-each-category-per-year-per-quarter">
<h3>4.10 Get the revenue for each Category Per Year Per Quarter:<a class="headerlink" href="#get-the-revenue-for-each-category-per-year-per-quarter" title="Permalink to this headline">¶</a></h3>
<p>This use case is inspired from https://databricks.com/blog/2016/02/09/reshaping-data-with-pivot-in-apache-spark.html</p>
<p><strong>Reshaping Data with Pivot in Apache Spark:</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">pivot</span></code> is applied after a <code class="docutils literal notranslate"><span class="pre">groupBy</span></code> operation. It pivots on a <code class="docutils literal notranslate"><span class="pre">pivotColumn</span></code> column, i.e. adds new columns per distinct values in <code class="docutils literal notranslate"><span class="pre">pivotColumn</span></code> and the values from the <code class="docutils literal notranslate"><span class="pre">groupBy</span></code> operation becomes the values in the correponding new distinct valued columns.</p>
<p><strong>SQL + DF API (prior to Spark 2.4.0)</strong><br />
Now we calculate total sales per quarter and then pivot on the quarter. <strong>There was no equivalent pivot function in SQL in Spark till 2.3.0</strong> so we had to do a combination of SQL to get the intermediate dataframe and then call the pivot function on that dataframe.</p>
<p>Let us first generate a subdataframe where we extract out the quarter from the order date. We would find the total per quarter for a given category per year.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rev_cat_qt_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;SELECT c.category_name, YEAR(o.order_date) as order_year, CONCAT(&#39;Q&#39;, QUARTER(o.order_date)) as order_quarter, order_item_subtotal</span>
<span class="sd">              |FROM orders o </span>
<span class="sd">              |INNER JOIN order_items oi on order_item_order_id = o.order_id</span>
<span class="sd">              |INNER JOIN products p on oi.order_item_product_id = p.product_id </span>
<span class="sd">              |INNER JOIN categories c on p.product_category_id = c.category_id</span>
<span class="sd">              |WHERE o.order_status &lt;&gt; &#39;CANCELED&#39; AND o.order_status &lt;&gt; &#39;SUSPECTED_FRAUD&#39;&quot;&quot;&quot;</span><span class="p">)))</span>

<span class="n">rev_cat_qt_df</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[category_name: string, order_year: int, order_quarter: string, order_item_subtotal: float]
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rev_cat_qt_df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+--------------------+----------+-------------+-------------------+
|       category_name|order_year|order_quarter|order_item_subtotal|
+--------------------+----------+-------------+-------------------+
|    Camping &amp; Hiking|      2013|           Q3|             299.98|
|        Water Sports|      2013|           Q3|             199.99|
|     Women&#39;s Apparel|      2013|           Q3|              250.0|
|      Men&#39;s Footwear|      2013|           Q3|             129.99|
|         Accessories|      2013|           Q3|              49.98|
|              Cleats|      2013|           Q3|             299.95|
|     Women&#39;s Apparel|      2013|           Q3|              150.0|
|Indoor/Outdoor Games|      2013|           Q3|             199.92|
|    Camping &amp; Hiking|      2013|           Q3|             299.98|
|              Cleats|      2013|           Q3|             299.95|
|Indoor/Outdoor Games|      2013|           Q3|              99.96|
|    Camping &amp; Hiking|      2013|           Q3|             299.98|
|      Men&#39;s Footwear|      2013|           Q3|             129.99|
|        Water Sports|      2013|           Q3|             199.99|
|    Camping &amp; Hiking|      2013|           Q3|             299.98|
|            Trade-In|      2013|           Q3|              79.95|
|              Cleats|      2013|           Q3|             179.97|
|              Cleats|      2013|           Q3|             299.95|
|Indoor/Outdoor Games|      2013|           Q3|             199.92|
|     Women&#39;s Apparel|      2013|           Q3|               50.0|
+--------------------+----------+-------------+-------------------+
only showing top 20 rows
</pre></div>
</div>
<p>​</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rev_cat_qt_pivot_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">rev_cat_qt_df</span>
              <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s1">&#39;category_name&#39;</span><span class="p">,</span> <span class="s1">&#39;order_year&#39;</span><span class="p">)</span>
              <span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s1">&#39;order_quarter&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Q1&#39;</span><span class="p">,</span> <span class="s1">&#39;Q2&#39;</span><span class="p">,</span> <span class="s1">&#39;Q3&#39;</span><span class="p">,</span> <span class="s1">&#39;Q4&#39;</span><span class="p">])</span> <span class="c1"># specifying the unique values (if we know) for pivot column makes execution faster</span>
              <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">&#39;order_item_subtotal&#39;</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
              <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;total_sales&#39;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;Q1&#39;</span><span class="p">),</span> <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">F</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;Q2&#39;</span><span class="p">),</span> <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">F</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;Q3&#39;</span><span class="p">),</span> <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="n">F</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;Q4&#39;</span><span class="p">),</span> <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span> <span class="mi">2</span><span class="p">))</span>
              <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s1">&#39;total_sales&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="n">rev_cat_qt_pivot_df</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[category_name: string, order_year: int, Q1: double, Q2: double, Q3: double, Q4: double, total_sales: double]
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rev_cat_qt_pivot_df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+--------------------+----------+----------+----------+----------+----------+-----------+
|       category_name|order_year|        Q1|        Q2|        Q3|        Q4|total_sales|
+--------------------+----------+----------+----------+----------+----------+-----------+
|             Fishing|      2014|1673916.35| 1594720.3| 415179.25|      null|  3683815.9|
|             Fishing|      2013|      null|      null|1248337.61|1705514.77| 2953852.38|
|              Cleats|      2014|1080480.24|1027808.94| 270734.96|      null| 2379024.14|
|    Camping &amp; Hiking|      2014| 981834.58| 935637.65| 273281.79|      null| 2190754.02|
|    Cardio Equipment|      2014| 855664.98| 873333.24| 223277.91|      null| 1952276.13|
|              Cleats|      2013|      null|      null| 806026.14|1059543.73| 1865569.87|
|    Camping &amp; Hiking|      2013|      null|      null| 745750.31|1010332.68| 1756082.99|
|     Women&#39;s Apparel|      2014|  756700.0|  728450.0|  196000.0|      null|  1681150.0|
|        Water Sports|      2014| 740763.07| 715814.31| 202239.92|      null|  1658817.3|
|    Cardio Equipment|      2013|      null|      null| 686091.93| 894921.15| 1581013.08|
|      Men&#39;s Footwear|      2014| 692846.73| 662689.05| 183025.93|      null| 1538561.71|
|Indoor/Outdoor Games|      2014| 684126.23| 674530.07| 172530.96|      null| 1531187.26|
|     Women&#39;s Apparel|      2013|      null|      null|  564200.0|  766250.0|  1330450.0|
|        Water Sports|      2013|      null|      null| 570671.53| 752362.46| 1323033.99|
|Indoor/Outdoor Games|      2013|      null|      null| 529937.93| 704418.11| 1234356.04|
|      Men&#39;s Footwear|      2013|      null|      null| 512680.58|  712735.2| 1225415.78|
|       Shop By Sport|      2014| 306115.55| 294338.72|  82260.02|      null|  682714.29|
|       Shop By Sport|      2013|      null|      null| 246249.99| 324431.35|  570681.34|
|         Electronics|      2014|  82597.71|  86027.36|   22332.4|      null|  190957.47|
|         Electronics|      2013|      null|      null|  68847.75|  97031.17|  165878.92|
+--------------------+----------+----------+----------+----------+----------+-----------+
only showing top 20 rows
</pre></div>
</div>
<p>​</p>
<p><strong>SQL (post Spark 2.4.0)</strong><br />
<strong>With Spark 2.4.0 SQL equivalent pivot function was introduced</strong>. Now we can achieve the same same with one query instead to DF + SQL combination.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
<span class="sd">&quot;&quot;&quot;SELECT *, ROUND(COALESCE(Q1, 0) + COALESCE(Q2, 0) + COALESCE(Q3, 0) + COALESCE(Q4, 0), 2) as total_sales FROM (</span>
<span class="sd">     SELECT * FROM (</span>
<span class="sd">        SELECT c.category_name, YEAR(o.order_date) as order_year, CONCAT(&#39;Q&#39;, QUARTER(o.order_date)) as order_quarter, order_item_subtotal</span>
<span class="sd">        FROM orders o </span>
<span class="sd">        INNER JOIN order_items oi on order_item_order_id = o.order_id</span>
<span class="sd">        INNER JOIN products p on oi.order_item_product_id = p.product_id </span>
<span class="sd">        INNER JOIN categories c on p.product_category_id = c.category_id</span>
<span class="sd">        WHERE o.order_status &lt;&gt; &#39;CANCELED&#39; AND o.order_status &lt;&gt; &#39;SUSPECTED_FRAUD&#39;</span>
<span class="sd">     )</span>
<span class="sd">     PIVOT (</span>
<span class="sd">        ROUND(SUM(order_item_subtotal), 2)</span>
<span class="sd">        FOR order_quarter in (&#39;Q1&#39;, &#39;Q2&#39;, &#39;Q3&#39;, &#39;Q4&#39;)</span>
<span class="sd">     )</span>
<span class="sd">   )</span>
<span class="sd">   ORDER BY total_sales DESC</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">)))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+--------------------+----------+----------+----------+----------+----------+-----------+
|       category_name|order_year|        Q1|        Q2|        Q3|        Q4|total_sales|
+--------------------+----------+----------+----------+----------+----------+-----------+
|             Fishing|      2014|1673916.35| 1594720.3| 415179.25|      null|  3683815.9|
|             Fishing|      2013|      null|      null|1248337.61|1705514.77| 2953852.38|
|              Cleats|      2014|1080480.24|1027808.94| 270734.96|      null| 2379024.14|
|    Camping &amp; Hiking|      2014| 981834.58| 935637.65| 273281.79|      null| 2190754.02|
|    Cardio Equipment|      2014| 855664.98| 873333.24| 223277.91|      null| 1952276.13|
|              Cleats|      2013|      null|      null| 806026.14|1059543.73| 1865569.87|
|    Camping &amp; Hiking|      2013|      null|      null| 745750.31|1010332.68| 1756082.99|
|     Women&#39;s Apparel|      2014|  756700.0|  728450.0|  196000.0|      null|  1681150.0|
|        Water Sports|      2014| 740763.07| 715814.31| 202239.92|      null|  1658817.3|
|    Cardio Equipment|      2013|      null|      null| 686091.93| 894921.15| 1581013.08|
|      Men&#39;s Footwear|      2014| 692846.73| 662689.05| 183025.93|      null| 1538561.71|
|Indoor/Outdoor Games|      2014| 684126.23| 674530.07| 172530.96|      null| 1531187.26|
|     Women&#39;s Apparel|      2013|      null|      null|  564200.0|  766250.0|  1330450.0|
|        Water Sports|      2013|      null|      null| 570671.53| 752362.46| 1323033.99|
|Indoor/Outdoor Games|      2013|      null|      null| 529937.93| 704418.11| 1234356.04|
|      Men&#39;s Footwear|      2013|      null|      null| 512680.58|  712735.2| 1225415.78|
|       Shop By Sport|      2014| 306115.55| 294338.72|  82260.02|      null|  682714.29|
|       Shop By Sport|      2013|      null|      null| 246249.99| 324431.35|  570681.34|
|         Electronics|      2014|  82597.71|  86027.36|   22332.4|      null|  190957.47|
|         Electronics|      2013|      null|      null|  68847.75|  97031.17|  165878.92|
+--------------------+----------+----------+----------+----------+----------+-----------+
only showing top 20 rows
</pre></div>
</div>
<p>​</p>
<p><strong>Revalidate above calculation with a specific year=’2013’ and category=’Fishing’:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># filter out item sales for Fishing in 2013</span>
<span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;SELECT c.category_name, YEAR(o.order_date) as order_year, concat(&#39;Q&#39;, QUARTER(o.order_date)) as order_quarter, ROUND(SUM(oi.order_item_subtotal), 2) as order_total </span>
<span class="sd">          |FROM orders o </span>
<span class="sd">          |INNER JOIN order_items oi on order_item_order_id = o.order_id</span>
<span class="sd">          |INNER JOIN products p on oi.order_item_product_id = p.product_id </span>
<span class="sd">          |INNER JOIN categories c on p.product_category_id = c.category_id</span>
<span class="sd">          |WHERE o.order_status &lt;&gt; &#39;CANCELED&#39; AND o.order_status &lt;&gt; &#39;SUSPECTED_FRAUD&#39;</span>
<span class="sd">          |AND YEAR(o.order_date) = 2013</span>
<span class="sd">          |AND c.category_name = &#39;Fishing&#39;</span>
<span class="sd">          |GROUP BY c.category_name, order_year, order_quarter</span>
<span class="sd">          |ORDER BY order_year, order_quarter, order_total DESC</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-------------+----------+-------------+-----------+
|category_name|order_year|order_quarter|order_total|
+-------------+----------+-------------+-----------+
|      Fishing|      2013|           Q3| 1248337.61|
|      Fishing|      2013|           Q4| 1705514.77|
+-------------+----------+-------------+-----------+
</pre></div>
</div>
<p>​</p>
<p>There are only two quarters Q3 and Q4 for Fishing in 2013 and the sum of the sales is 1248337.61 + 1705514.77 = 2953852.38</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># filter out pivot data for Fishing in 2013</span>
<span class="n">rev_cat_qt_pivot_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;order_year&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2013</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;category_name&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;Fishing&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-------------+----------+----+----+----------+----------+-----------+
|category_name|order_year|  Q1|  Q2|        Q3|        Q4|total_sales|
+-------------+----------+----+----+----------+----------+-----------+
|      Fishing|      2013|null|null|1248337.61|1705514.77| 2953852.38|
+-------------+----------+----+----+----------+----------+-----------+
</pre></div>
</div>
<p>​</p>
<p>From the pivot table we can verify that Q1 and Q2 had no sale and the sum of total sales in quarters Q3 and Q4 for Fishing in 2013 2953852.38 Hence, we can verify that our pivot function is working fine.</p>
<p><strong>Visualise the quarter wise sales for 2013 and 2014 across various categories in different quarters:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rev_cat_qt_pivot_pdf</span> <span class="o">=</span> <span class="n">rev_cat_qt_pivot_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;order_year&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2013</span><span class="p">)</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rev_cat_qt_pivot_pdf</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>.dataframe thead th {
    text-align: left;
}

.dataframe tbody tr th {
    vertical-align: top;
}
</pre></div>
</div>
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>category_name</th>
      <th>order_year</th>
      <th>Q1</th>
      <th>Q2</th>
      <th>Q3</th>
      <th>Q4</th>
      <th>total_sales</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Fishing</td>
      <td>2013</td>
      <td>None</td>
      <td>None</td>
      <td>1248337.61</td>
      <td>1705514.77</td>
      <td>2953852.38</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Cleats</td>
      <td>2013</td>
      <td>None</td>
      <td>None</td>
      <td>806026.14</td>
      <td>1059543.73</td>
      <td>1865569.87</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Camping &amp; Hiking</td>
      <td>2013</td>
      <td>None</td>
      <td>None</td>
      <td>745750.31</td>
      <td>1010332.68</td>
      <td>1756082.99</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Cardio Equipment</td>
      <td>2013</td>
      <td>None</td>
      <td>None</td>
      <td>686091.93</td>
      <td>894921.15</td>
      <td>1581013.08</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Women's Apparel</td>
      <td>2013</td>
      <td>None</td>
      <td>None</td>
      <td>564200.00</td>
      <td>766250.00</td>
      <td>1330450.00</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rev_cat_qt_pivot_pdf</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;order_year&#39;</span><span class="p">,</span> <span class="s1">&#39;total_sales&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;category_name&#39;</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Revenue for each Category Per Quarter in 2013&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p><img alt="png" src="../_images/output_170_0.png" /></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rev_cat_qt_pivot_pdf</span> <span class="o">=</span> <span class="n">rev_cat_qt_pivot_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;order_year&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2014</span><span class="p">)</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rev_cat_qt_pivot_pdf</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;order_year&#39;</span><span class="p">,</span> <span class="s1">&#39;total_sales&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;category_name&#39;</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Revenue for each Category Per Quarter in 2014&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p><img alt="png" src="../_images/output_172_0.png" /></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rev_cat_qt_df</span><span class="o">.</span><span class="n">unpersist</span><span class="p">()</span>
<span class="n">rev_cat_qt_pivot_df</span><span class="o">.</span><span class="n">unpersist</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[category_name: string, order_year: int, order_quarter: string, order_item_subtotal: float]






DataFrame[category_name: string, order_year: int, Q1: double, Q2: double, Q3: double, Q4: double, total_sales: double]
</pre></div>
</div>
<p><a class="reference external" href="#Table-of-contents">Back to Top</a></p>
</div>
<div class="section" id="get-number-of-orders-by-status">
<h3>4.11 Get Number of Orders By Status:<a class="headerlink" href="#get-number-of-orders-by-status" title="Permalink to this headline">¶</a></h3>
<p><strong>SQL:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;SELECT order_status, COUNT(1) as total</span>
<span class="sd">          |FROM orders o</span>
<span class="sd">          |GROUP BY o.order_status</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+---------------+-----+
|   order_status|total|
+---------------+-----+
|PENDING_PAYMENT|15030|
|       COMPLETE|22899|
|        ON_HOLD| 3798|
| PAYMENT_REVIEW|  729|
|     PROCESSING| 8275|
|         CLOSED| 7556|
|SUSPECTED_FRAUD| 1558|
|        PENDING| 7610|
|       CANCELED| 1428|
+---------------+-----+
</pre></div>
</div>
<p>​</p>
<p><strong>DF API:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">orders_df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="n">orders_df</span><span class="o">.</span><span class="n">order_status</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;total&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[order_status: string, total: bigint]
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+---------------+-----+
|   order_status|total|
+---------------+-----+
|PENDING_PAYMENT|15030|
|       COMPLETE|22899|
|        ON_HOLD| 3798|
| PAYMENT_REVIEW|  729|
|     PROCESSING| 8275|
|         CLOSED| 7556|
|SUSPECTED_FRAUD| 1558|
|        PENDING| 7610|
|       CANCELED| 1428|
+---------------+-----+
</pre></div>
</div>
<p>​</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pdf</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;order_status&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">pdf</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Number of Orders By Status&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p><img alt="png" src="../_images/output_182_0.png" /></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">unpersist</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[order_status: string, total: bigint]
</pre></div>
</div>
<p><a class="reference external" href="#Table-of-contents">Back to Top</a></p>
</div>
<div class="section" id="get-number-of-orders-by-order-date-and-order-status">
<h3>4.12 Get Number of Orders By Order Date and Order Status:<a class="headerlink" href="#get-number-of-orders-by-order-date-and-order-status" title="Permalink to this headline">¶</a></h3>
<p><strong>SQL:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;SELECT order_date, order_status, COUNT(1) as total</span>
<span class="sd">          |FROM orders o</span>
<span class="sd">          |GROUP BY order_date, o.order_status</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+---------------------+---------------+-----+
|order_date           |order_status   |total|
+---------------------+---------------+-----+
|2013-08-16 00:00:00.0|COMPLETE       |43   |
|2013-08-30 00:00:00.0|CLOSED         |17   |
|2013-09-10 00:00:00.0|COMPLETE       |80   |
|2013-10-05 00:00:00.0|SUSPECTED_FRAUD|4    |
|2013-12-02 00:00:00.0|SUSPECTED_FRAUD|3    |
|2013-12-09 00:00:00.0|ON_HOLD        |9    |
|2013-12-20 00:00:00.0|SUSPECTED_FRAUD|3    |
|2013-12-23 00:00:00.0|PAYMENT_REVIEW |2    |
|2014-01-02 00:00:00.0|CLOSED         |15   |
|2014-02-11 00:00:00.0|CANCELED       |3    |
|2014-02-14 00:00:00.0|ON_HOLD        |11   |
|2014-02-21 00:00:00.0|PROCESSING     |25   |
|2014-05-13 00:00:00.0|SUSPECTED_FRAUD|3    |
|2014-06-27 00:00:00.0|PENDING        |26   |
|2014-07-16 00:00:00.0|ON_HOLD        |3    |
|2013-08-16 00:00:00.0|PENDING_PAYMENT|30   |
|2013-08-29 00:00:00.0|PROCESSING     |31   |
|2013-09-10 00:00:00.0|SUSPECTED_FRAUD|3    |
|2013-09-25 00:00:00.0|CLOSED         |28   |
|2013-09-27 00:00:00.0|PENDING_PAYMENT|56   |
+---------------------+---------------+-----+
only showing top 20 rows
</pre></div>
</div>
<p>​</p>
<p><strong>DF API:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">orders_df</span>
 <span class="o">.</span><span class="n">groupBy</span><span class="p">([</span><span class="n">orders_df</span><span class="o">.</span><span class="n">order_date</span><span class="p">,</span> <span class="n">orders_df</span><span class="o">.</span><span class="n">order_status</span><span class="p">])</span>
 <span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;total&#39;</span><span class="p">)</span>
 <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+---------------------+---------------+-----+
|order_date           |order_status   |total|
+---------------------+---------------+-----+
|2013-08-16 00:00:00.0|COMPLETE       |43   |
|2013-08-30 00:00:00.0|CLOSED         |17   |
|2013-09-10 00:00:00.0|COMPLETE       |80   |
|2013-10-05 00:00:00.0|SUSPECTED_FRAUD|4    |
|2013-12-02 00:00:00.0|SUSPECTED_FRAUD|3    |
|2013-12-09 00:00:00.0|ON_HOLD        |9    |
|2013-12-20 00:00:00.0|SUSPECTED_FRAUD|3    |
|2013-12-23 00:00:00.0|PAYMENT_REVIEW |2    |
|2014-01-02 00:00:00.0|CLOSED         |15   |
|2014-02-11 00:00:00.0|CANCELED       |3    |
|2014-02-14 00:00:00.0|ON_HOLD        |11   |
|2014-02-21 00:00:00.0|PROCESSING     |25   |
|2014-05-13 00:00:00.0|SUSPECTED_FRAUD|3    |
|2014-06-27 00:00:00.0|PENDING        |26   |
|2014-07-16 00:00:00.0|ON_HOLD        |3    |
|2013-08-16 00:00:00.0|PENDING_PAYMENT|30   |
|2013-08-29 00:00:00.0|PROCESSING     |31   |
|2013-09-10 00:00:00.0|SUSPECTED_FRAUD|3    |
|2013-09-25 00:00:00.0|CLOSED         |28   |
|2013-09-27 00:00:00.0|PENDING_PAYMENT|56   |
+---------------------+---------------+-----+
only showing top 20 rows
</pre></div>
</div>
<p>​</p>
<p><a class="reference external" href="#Table-of-contents">Back to Top</a></p>
</div>
<div class="section" id="get-all-canceled-orders-with-amount-greater-than-1000">
<h3>4.13 Get all CANCELED orders with amount greater than $1000:<a class="headerlink" href="#get-all-canceled-orders-with-amount-greater-than-1000" title="Permalink to this headline">¶</a></h3>
<p><strong>SQL:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
    <span class="sd">&quot;&quot;&quot;SELECT q.* </span>
<span class="sd">      |FROM (SELECT o.order_id, o.order_date, o.order_customer_id, o.order_status, SUM(oi.order_item_subtotal) as order_total </span>
<span class="sd">      |      FROM orders o INNER JOIN order_items oi </span>
<span class="sd">      |          ON o.order_id = oi.order_item_order_id </span>
<span class="sd">      |      WHERE o.order_status = &#39;CANCELED&#39; </span>
<span class="sd">      |      GROUP BY o.order_id, o.order_date, o.order_customer_id, o.order_status) q </span>
<span class="sd">      |WHERE q.order_total &gt;= 1000 </span>
<span class="sd">      |ORDER BY q.order_id</span>
<span class="sd">    &quot;&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+--------+---------------------+-----------------+------------+------------------+
|order_id|order_date           |order_customer_id|order_status|order_total       |
+--------+---------------------+-----------------+------------+------------------+
|753     |2013-07-29 00:00:00.0|5094             |CANCELED    |1129.75           |
|2012    |2013-08-04 00:00:00.0|5165             |CANCELED    |1499.8600311279297|
|2144    |2013-08-05 00:00:00.0|7932             |CANCELED    |1099.900032043457 |
|2189    |2013-08-06 00:00:00.0|6829             |CANCELED    |1029.9400253295898|
|2271    |2013-08-06 00:00:00.0|7603             |CANCELED    |1229.9300231933594|
|2754    |2013-08-09 00:00:00.0|8946             |CANCELED    |1109.9500274658203|
|3551    |2013-08-14 00:00:00.0|5363             |CANCELED    |1299.8700408935547|
|4354    |2013-08-20 00:00:00.0|7268             |CANCELED    |1047.9000244140625|
|4801    |2013-08-23 00:00:00.0|11630            |CANCELED    |1016.9500217437744|
|5331    |2013-08-26 00:00:00.0|3361             |CANCELED    |1229.8100204467773|
|5613    |2013-08-28 00:00:00.0|7052             |CANCELED    |1049.8700103759766|
|6180    |2013-09-02 00:00:00.0|8688             |CANCELED    |1059.8800354003906|
|6231    |2013-09-02 00:00:00.0|12347            |CANCELED    |1279.8900299072266|
|6548    |2013-09-04 00:00:00.0|172              |CANCELED    |1069.910026550293 |
|6819    |2013-09-06 00:00:00.0|1548             |CANCELED    |1149.8500366210938|
|7053    |2013-09-07 00:00:00.0|10424            |CANCELED    |1339.8500213623047|
|7360    |2013-09-08 00:00:00.0|12102            |CANCELED    |1009.9200286865234|
|7491    |2013-09-09 00:00:00.0|6892             |CANCELED    |1249.8500213623047|
|8433    |2013-09-15 00:00:00.0|6568             |CANCELED    |1329.9200439453125|
|8488    |2013-09-16 00:00:00.0|9154             |CANCELED    |1079.8900108337402|
+--------+---------------------+-----------------+------------+------------------+
only showing top 20 rows
</pre></div>
</div>
<p>​</p>
<p><strong>DF API:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cancelled_orders</span> <span class="o">=</span> <span class="p">(</span><span class="n">orders_df</span>
                 <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;order_status&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;CANCELED&#39;</span><span class="p">)</span>
                 <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">order_items_df</span><span class="p">,</span> <span class="n">orders_df</span><span class="o">.</span><span class="n">order_id</span> <span class="o">==</span> <span class="n">order_items_df</span><span class="o">.</span><span class="n">order_item_order_id</span><span class="p">)</span>
                 <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="n">orders_df</span><span class="o">.</span><span class="n">order_id</span><span class="p">,</span> <span class="n">orders_df</span><span class="o">.</span><span class="n">order_date</span><span class="p">,</span> <span class="n">orders_df</span><span class="o">.</span><span class="n">order_customer_id</span><span class="p">,</span> <span class="n">orders_df</span><span class="o">.</span><span class="n">order_status</span><span class="p">)</span>
                 <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">&#39;order_item_subtotal&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;order_total&#39;</span><span class="p">))</span>
                 <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;order_total&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">)</span>
                 <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s1">&#39;order_id&#39;</span><span class="p">))</span>

<span class="n">cancelled_orders</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[order_id: int, order_date: string, order_customer_id: int, order_status: string, order_total: double]
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cancelled_orders</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+--------+---------------------+-----------------+------------+------------------+
|order_id|order_date           |order_customer_id|order_status|order_total       |
+--------+---------------------+-----------------+------------+------------------+
|753     |2013-07-29 00:00:00.0|5094             |CANCELED    |1129.75           |
|2012    |2013-08-04 00:00:00.0|5165             |CANCELED    |1499.8600311279297|
|2144    |2013-08-05 00:00:00.0|7932             |CANCELED    |1099.900032043457 |
|2189    |2013-08-06 00:00:00.0|6829             |CANCELED    |1029.9400253295898|
|2271    |2013-08-06 00:00:00.0|7603             |CANCELED    |1229.9300231933594|
|2754    |2013-08-09 00:00:00.0|8946             |CANCELED    |1109.9500274658203|
|3551    |2013-08-14 00:00:00.0|5363             |CANCELED    |1299.8700408935547|
|4354    |2013-08-20 00:00:00.0|7268             |CANCELED    |1047.9000244140625|
|4801    |2013-08-23 00:00:00.0|11630            |CANCELED    |1016.9500217437744|
|5331    |2013-08-26 00:00:00.0|3361             |CANCELED    |1229.8100204467773|
|5613    |2013-08-28 00:00:00.0|7052             |CANCELED    |1049.8700103759766|
|6180    |2013-09-02 00:00:00.0|8688             |CANCELED    |1059.8800354003906|
|6231    |2013-09-02 00:00:00.0|12347            |CANCELED    |1279.8900299072266|
|6548    |2013-09-04 00:00:00.0|172              |CANCELED    |1069.910026550293 |
|6819    |2013-09-06 00:00:00.0|1548             |CANCELED    |1149.8500366210938|
|7053    |2013-09-07 00:00:00.0|10424            |CANCELED    |1339.8500213623047|
|7360    |2013-09-08 00:00:00.0|12102            |CANCELED    |1009.9200286865234|
|7491    |2013-09-09 00:00:00.0|6892             |CANCELED    |1249.8500213623047|
|8433    |2013-09-15 00:00:00.0|6568             |CANCELED    |1329.9200439453125|
|8488    |2013-09-16 00:00:00.0|9154             |CANCELED    |1079.8900108337402|
+--------+---------------------+-----------------+------------+------------------+
only showing top 20 rows
</pre></div>
</div>
<p>​</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">cancelled_orders</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s1">&#39;order_total&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;CANCELED orders with amount greater than $1000&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Amount&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Count&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p><img alt="png" src="../_images/output_197_0.png" /></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cancelled_orders</span><span class="o">.</span><span class="n">unpersist</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[order_id: int, order_date: string, order_customer_id: int, order_status: string, order_total: double]
</pre></div>
</div>
<p><a class="reference external" href="#Table-of-contents">Back to Top</a></p>
</div>
<div class="section" id="sort-products-by-category-and-price">
<h3>4.14 Sort Products by Category and Price:<a class="headerlink" href="#sort-products-by-category-and-price" title="Permalink to this headline">¶</a></h3>
<p><strong>SQL:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;SELECT p.product_id, p.product_category_id, p.product_name, p.product_price</span>
<span class="sd">          |FROM products p</span>
<span class="sd">          |ORDER BY p.product_category_id ASC, p.product_price DESC</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+----------+-------------------+---------------------------------------------+-------------+
|product_id|product_category_id|product_name                                 |product_price|
+----------+-------------------+---------------------------------------------+-------------+
|16        |2                  |Riddell Youth 360 Custom Football Helmet     |299.99       |
|11        |2                  |Fitness Gear 300 lb Olympic Weight Set       |209.99       |
|5         |2                  |Riddell Youth Revolution Speed Custom Footbal|199.99       |
|14        |2                  |Quik Shade Summit SX170 10 FT. x 10 FT. Canop|199.99       |
|12        |2                  |Under Armour Men&#39;s Highlight MC Alter Ego Fla|139.99       |
|23        |2                  |Under Armour Men&#39;s Highlight MC Alter Ego Hul|139.99       |
|6         |2                  |Jordan Men&#39;s VI Retro TD Football Cleat      |134.99       |
|20        |2                  |Under Armour Men&#39;s Highlight MC Football Clea|129.99       |
|8         |2                  |Nike Men&#39;s Vapor Carbon Elite TD Football Cle|129.99       |
|17        |2                  |Under Armour Men&#39;s Highlight MC Football Clea|129.99       |
|2         |2                  |Under Armour Men&#39;s Highlight MC Football Clea|129.99       |
|10        |2                  |Under Armour Men&#39;s Highlight MC Football Clea|129.99       |
|19        |2                  |Nike Men&#39;s Fingertrap Max Training Shoe      |124.99       |
|7         |2                  |Schutt Youth Recruit Hybrid Custom Football H|99.99        |
|3         |2                  |Under Armour Men&#39;s Renegade D Mid Football Cl|89.99        |
|4         |2                  |Under Armour Men&#39;s Renegade D Mid Football Cl|89.99        |
|13        |2                  |Under Armour Men&#39;s Renegade D Mid Football Cl|89.99        |
|24        |2                  |Elevation Training Mask 2.0                  |79.99        |
|15        |2                  |Under Armour Kids&#39; Highlight RM Alter Ego Sup|59.99        |
|1         |2                  |Quest Q64 10 FT. x 10 FT. Slant Leg Instant U|59.98        |
+----------+-------------------+---------------------------------------------+-------------+
only showing top 20 rows
</pre></div>
</div>
<p>​</p>
<p><strong>DF API:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">products_df</span>
 <span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s1">&#39;product_id&#39;</span><span class="p">,</span> <span class="s1">&#39;product_category_id&#39;</span><span class="p">,</span> <span class="s1">&#39;product_name&#39;</span><span class="p">,</span> <span class="s1">&#39;product_price&#39;</span><span class="p">])</span>
 <span class="o">.</span><span class="n">orderBy</span><span class="p">([</span><span class="s1">&#39;product_category_id&#39;</span><span class="p">,</span> <span class="s1">&#39;product_price&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
 <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+----------+-------------------+---------------------------------------------+-------------+
|product_id|product_category_id|product_name                                 |product_price|
+----------+-------------------+---------------------------------------------+-------------+
|16        |2                  |Riddell Youth 360 Custom Football Helmet     |299.99       |
|11        |2                  |Fitness Gear 300 lb Olympic Weight Set       |209.99       |
|5         |2                  |Riddell Youth Revolution Speed Custom Footbal|199.99       |
|14        |2                  |Quik Shade Summit SX170 10 FT. x 10 FT. Canop|199.99       |
|12        |2                  |Under Armour Men&#39;s Highlight MC Alter Ego Fla|139.99       |
|23        |2                  |Under Armour Men&#39;s Highlight MC Alter Ego Hul|139.99       |
|6         |2                  |Jordan Men&#39;s VI Retro TD Football Cleat      |134.99       |
|20        |2                  |Under Armour Men&#39;s Highlight MC Football Clea|129.99       |
|8         |2                  |Nike Men&#39;s Vapor Carbon Elite TD Football Cle|129.99       |
|17        |2                  |Under Armour Men&#39;s Highlight MC Football Clea|129.99       |
|2         |2                  |Under Armour Men&#39;s Highlight MC Football Clea|129.99       |
|10        |2                  |Under Armour Men&#39;s Highlight MC Football Clea|129.99       |
|19        |2                  |Nike Men&#39;s Fingertrap Max Training Shoe      |124.99       |
|7         |2                  |Schutt Youth Recruit Hybrid Custom Football H|99.99        |
|3         |2                  |Under Armour Men&#39;s Renegade D Mid Football Cl|89.99        |
|4         |2                  |Under Armour Men&#39;s Renegade D Mid Football Cl|89.99        |
|13        |2                  |Under Armour Men&#39;s Renegade D Mid Football Cl|89.99        |
|24        |2                  |Elevation Training Mask 2.0                  |79.99        |
|15        |2                  |Under Armour Kids&#39; Highlight RM Alter Ego Sup|59.99        |
|1         |2                  |Quest Q64 10 FT. x 10 FT. Slant Leg Instant U|59.98        |
+----------+-------------------+---------------------------------------------+-------------+
only showing top 20 rows
</pre></div>
</div>
<p>​</p>
<p><a class="reference external" href="#Table-of-contents">Back to Top</a></p>
</div>
<div class="section" id="sort-products-by-price-within-each-category">
<h3>4.15 Sort Products by Price within Each Category:<a class="headerlink" href="#sort-products-by-price-within-each-category" title="Permalink to this headline">¶</a></h3>
<p><strong>SQL:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;SELECT p.product_id, p.product_category_id, p.product_name, p.product_price</span>
<span class="sd">          |FROM products p </span>
<span class="sd">          |DISTRIBUTE BY p.product_category_id </span>
<span class="sd">          |SORT BY p.product_price DESC</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">withReplacement</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">23</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+----------+-------------------+----------------------------------------------+-------------+
|product_id|product_category_id|product_name                                  |product_price|
+----------+-------------------+----------------------------------------------+-------------+
|681       |31                 |Boccieri Golf EL C2-M Counterbalance Putter   |119.99       |
|1192      |53                 |Nike Men&#39;s Kobe IX Elite Low Basketball Shoe  |199.99       |
|747       |34                 |Ogio City Spiked Golf Shoes                   |149.99       |
|758       |34                 |TRUE linkswear Vegas Golf Shoes               |99.99        |
|595       |27                 |TYR Girls&#39; Phoenix Maxfit Back Swimsuit       |75.99        |
|549       |26                 |Lotto Men&#39;s Zhero Gravity V 700 TF Soccer Cle |59.99        |
|551       |26                 |Lotto Men&#39;s Zhero Gravity V 700 TF Soccer Cle |59.99        |
|572       |26                 |TYR Boys&#39; Team Digi Jammer                    |39.99        |
|561       |26                 |adidas Men&#39;s 2014 MLS All-Star Game Lumber Hu |22.0         |
|554       |26                 |adidas Men&#39;s 2014 MLS All-Star Game Cross Bla |20.0         |
|974       |44                 |The North Face Women&#39;s Stinson Rain Jacket    |90.0         |
|246       |12                 |Nike Women&#39;s Tempo Shorts                     |30.0         |
|484       |22                 |Nike Men&#39;s Free 5.0+ Running Shoe             |99.99        |
|483       |22                 |Nike Women&#39;s Tempo Shorts                     |30.0         |
|485       |22                 |&quot;Nike Women&#39;s Pro Core 3&quot;&quot; Compression Shorts&quot;|28.0         |
|1056      |47                 |Garmin vivofit Fitness Band with HRM          |169.99       |
|1042      |47                 |Under Armour Hustle Backpack                  |54.99        |
|1047      |47                 |Under Armour Men&#39;s Ignite Camo II Slide       |34.99        |
|1157      |52                 |Reebok Men&#39;s Chicago Blackhawks Jonathan Toew |170.0        |
|1160      |52                 |Reebok Women&#39;s Chicago Blackhawks Patrick Kan |130.0        |
+----------+-------------------+----------------------------------------------+-------------+
only showing top 20 rows
</pre></div>
</div>
<p>​</p>
<p><strong>DF API:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">products_df</span>
 <span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="s1">&#39;product_category_id&#39;</span><span class="p">)</span>
 <span class="o">.</span><span class="n">sortWithinPartitions</span><span class="p">(</span><span class="s1">&#39;product_price&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
 <span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">withReplacement</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">23</span><span class="p">)</span>
 <span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s1">&#39;product_id&#39;</span><span class="p">,</span> <span class="s1">&#39;product_category_id&#39;</span><span class="p">,</span> <span class="s1">&#39;product_name&#39;</span><span class="p">,</span> <span class="s1">&#39;product_price&#39;</span><span class="p">])</span>
 <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+----------+-------------------+----------------------------------------------+-------------+
|product_id|product_category_id|product_name                                  |product_price|
+----------+-------------------+----------------------------------------------+-------------+
|681       |31                 |Boccieri Golf EL C2-M Counterbalance Putter   |119.99       |
|1192      |53                 |Nike Men&#39;s Kobe IX Elite Low Basketball Shoe  |199.99       |
|747       |34                 |Ogio City Spiked Golf Shoes                   |149.99       |
|758       |34                 |TRUE linkswear Vegas Golf Shoes               |99.99        |
|595       |27                 |TYR Girls&#39; Phoenix Maxfit Back Swimsuit       |75.99        |
|549       |26                 |Lotto Men&#39;s Zhero Gravity V 700 TF Soccer Cle |59.99        |
|551       |26                 |Lotto Men&#39;s Zhero Gravity V 700 TF Soccer Cle |59.99        |
|572       |26                 |TYR Boys&#39; Team Digi Jammer                    |39.99        |
|561       |26                 |adidas Men&#39;s 2014 MLS All-Star Game Lumber Hu |22.0         |
|554       |26                 |adidas Men&#39;s 2014 MLS All-Star Game Cross Bla |20.0         |
|974       |44                 |The North Face Women&#39;s Stinson Rain Jacket    |90.0         |
|246       |12                 |Nike Women&#39;s Tempo Shorts                     |30.0         |
|484       |22                 |Nike Men&#39;s Free 5.0+ Running Shoe             |99.99        |
|483       |22                 |Nike Women&#39;s Tempo Shorts                     |30.0         |
|485       |22                 |&quot;Nike Women&#39;s Pro Core 3&quot;&quot; Compression Shorts&quot;|28.0         |
|1056      |47                 |Garmin vivofit Fitness Band with HRM          |169.99       |
|1042      |47                 |Under Armour Hustle Backpack                  |54.99        |
|1047      |47                 |Under Armour Men&#39;s Ignite Camo II Slide       |34.99        |
|1157      |52                 |Reebok Men&#39;s Chicago Blackhawks Jonathan Toew |170.0        |
|1160      |52                 |Reebok Women&#39;s Chicago Blackhawks Patrick Kan |130.0        |
+----------+-------------------+----------------------------------------------+-------------+
only showing top 20 rows
</pre></div>
</div>
<p>​</p>
<p><a class="reference external" href="#Table-of-contents">Back to Top</a></p>
</div>
<div class="section" id="get-the-topmost-5-products-overall-sorted-by-price-highest-to-lowest">
<h3>4.16 Get the topmost 5 products overall sorted by Price Highest to Lowest:<a class="headerlink" href="#get-the-topmost-5-products-overall-sorted-by-price-highest-to-lowest" title="Permalink to this headline">¶</a></h3>
<p><strong>sortN: get top 5 products by price overall; globalSorting</strong></p>
<p><strong>SQL:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;SELECT product_id, product_category_id, product_name, product_price</span>
<span class="sd">          |FROM products</span>
<span class="sd">          |ORDER BY product_price DESC</span>
<span class="sd">          |LIMIT 5</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+----------+-------------------+------------------------------------------------+-------------+
|product_id|product_category_id|product_name                                    |product_price|
+----------+-------------------+------------------------------------------------+-------------+
|208       |10                 |SOLE E35 Elliptical                             |1999.99      |
|66        |4                  |SOLE F85 Treadmill                              |1799.99      |
|199       |10                 |SOLE F85 Treadmill                              |1799.99      |
|496       |22                 |SOLE F85 Treadmill                              |1799.99      |
|1048      |47                 |&quot;Spalding Beast 60&quot;&quot; Glass Portable Basketball &quot;|1099.99      |
+----------+-------------------+------------------------------------------------+-------------+
</pre></div>
</div>
<p>​</p>
<p><strong>DF API:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">products_df</span>
    <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;product_id&#39;</span><span class="p">,</span> <span class="s1">&#39;product_category_id&#39;</span><span class="p">,</span> <span class="s1">&#39;product_name&#39;</span><span class="p">,</span> <span class="s1">&#39;product_price&#39;</span><span class="p">)</span>
     <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s1">&#39;product_price&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
     <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
     <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+----------+-------------------+------------------------------------------------+-------------+
|product_id|product_category_id|product_name                                    |product_price|
+----------+-------------------+------------------------------------------------+-------------+
|208       |10                 |SOLE E35 Elliptical                             |1999.99      |
|66        |4                  |SOLE F85 Treadmill                              |1799.99      |
|199       |10                 |SOLE F85 Treadmill                              |1799.99      |
|496       |22                 |SOLE F85 Treadmill                              |1799.99      |
|1048      |47                 |&quot;Spalding Beast 60&quot;&quot; Glass Portable Basketball &quot;|1099.99      |
+----------+-------------------+------------------------------------------------+-------------+
</pre></div>
</div>
<p>​</p>
<p><a class="reference external" href="#Table-of-contents">Back to Top</a></p>
</div>
<div class="section" id="get-the-topmost-5-products-in-each-category-where-the-products-are-sorted-by-price-highest-to-lowest">
<h3>4.17 Get the topmost 5 products in each category where the products are sorted by Price Highest to Lowest:<a class="headerlink" href="#get-the-topmost-5-products-in-each-category-where-the-products-are-sorted-by-price-highest-to-lowest" title="Permalink to this headline">¶</a></h3>
<p><strong>sort: sortingByKey, sort() by price per category</strong></p>
<p><strong>SQL:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;SELECT product_category_id, product_id, product_name, product_price, row_num</span>
<span class="sd">          |FROM ( </span>
<span class="sd">          |     SELECT q.*, row_number() OVER (PARTITION BY q.product_category_id ORDER BY q.product_price DESC) as row_num </span>
<span class="sd">          |     FROM products q)</span>
<span class="sd">          |WHERE row_num &lt;= 5 </span>
<span class="sd">          |ORDER BY product_category_id, row_num</span>
<span class="sd">          |      </span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-------------------+----------+------------------------------------------------+-------------+-------+
|product_category_id|product_id|product_name                                    |product_price|row_num|
+-------------------+----------+------------------------------------------------+-------------+-------+
|2                  |16        |Riddell Youth 360 Custom Football Helmet        |299.99       |1      |
|2                  |11        |Fitness Gear 300 lb Olympic Weight Set          |209.99       |2      |
|2                  |5         |Riddell Youth Revolution Speed Custom Footbal   |199.99       |3      |
|2                  |14        |Quik Shade Summit SX170 10 FT. x 10 FT. Canop   |199.99       |4      |
|2                  |12        |Under Armour Men&#39;s Highlight MC Alter Ego Fla   |139.99       |5      |
|3                  |40        |Quik Shade Summit SX170 10 FT. x 10 FT. Canop   |199.99       |1      |
|3                  |32        |PUMA Men&#39;s evoPOWER 1 Tricks FG Soccer Cleat    |189.99       |2      |
|3                  |35        |adidas Brazuca 2014 Official Match Ball         |159.99       |3      |
|3                  |48        |adidas Brazuca Final Rio Official Match Ball    |159.99       |4      |
|3                  |46        |Quest 12&#39; x 12&#39; Dome Canopy                     |149.99       |5      |
|4                  |66        |SOLE F85 Treadmill                              |1799.99      |1      |
|4                  |60        |SOLE E25 Elliptical                             |999.99       |2      |
|4                  |71        |Diamondback Adult Response XE Mountain Bike 2   |349.98       |3      |
|4                  |68        |Diamondback Adult Outlook Mountain Bike 2014    |309.99       |4      |
|4                  |58        |Diamondback Boys&#39; Insight 24 Performance Hybr   |299.99       |5      |
|5                  |74        |&quot;Goaliath 54&quot;&quot; In-Ground Basketball Hoop with P&quot;|499.99       |1      |
|5                  |96        |Teeter Hang Ups NXT-S Inversion Table           |299.99       |2      |
|5                  |79        |Fitness Gear 300 lb Olympic Weight Set          |209.99       |3      |
|5                  |81        |Quik Shade Summit SX170 10 FT. x 10 FT. Canop   |199.99       |4      |
|5                  |90        |Nike Men&#39;s LeBron XI Basketball Shoe            |199.99       |5      |
+-------------------+----------+------------------------------------------------+-------------+-------+
only showing top 20 rows
</pre></div>
</div>
<p>​</p>
<p><strong>DF API:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">windowSpec</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="n">products_df</span><span class="p">[</span><span class="s1">&#39;product_category_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">products_df</span><span class="p">[</span><span class="s1">&#39;product_price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">products_df</span>
    <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;product_category_id&#39;</span><span class="p">,</span> <span class="s1">&#39;product_id&#39;</span><span class="p">,</span> <span class="s1">&#39;product_name&#39;</span><span class="p">,</span> <span class="s1">&#39;product_price&#39;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">row_number</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">windowSpec</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;row_num&#39;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;row_num&#39;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span>
    <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s1">&#39;product_category_id&#39;</span><span class="p">,</span> <span class="s1">&#39;row_num&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-------------------+----------+------------------------------------------------+-------------+-------+
|product_category_id|product_id|product_name                                    |product_price|row_num|
+-------------------+----------+------------------------------------------------+-------------+-------+
|2                  |16        |Riddell Youth 360 Custom Football Helmet        |299.99       |1      |
|2                  |11        |Fitness Gear 300 lb Olympic Weight Set          |209.99       |2      |
|2                  |5         |Riddell Youth Revolution Speed Custom Footbal   |199.99       |3      |
|2                  |14        |Quik Shade Summit SX170 10 FT. x 10 FT. Canop   |199.99       |4      |
|2                  |12        |Under Armour Men&#39;s Highlight MC Alter Ego Fla   |139.99       |5      |
|3                  |40        |Quik Shade Summit SX170 10 FT. x 10 FT. Canop   |199.99       |1      |
|3                  |32        |PUMA Men&#39;s evoPOWER 1 Tricks FG Soccer Cleat    |189.99       |2      |
|3                  |35        |adidas Brazuca 2014 Official Match Ball         |159.99       |3      |
|3                  |48        |adidas Brazuca Final Rio Official Match Ball    |159.99       |4      |
|3                  |46        |Quest 12&#39; x 12&#39; Dome Canopy                     |149.99       |5      |
|4                  |66        |SOLE F85 Treadmill                              |1799.99      |1      |
|4                  |60        |SOLE E25 Elliptical                             |999.99       |2      |
|4                  |71        |Diamondback Adult Response XE Mountain Bike 2   |349.98       |3      |
|4                  |68        |Diamondback Adult Outlook Mountain Bike 2014    |309.99       |4      |
|4                  |58        |Diamondback Boys&#39; Insight 24 Performance Hybr   |299.99       |5      |
|5                  |74        |&quot;Goaliath 54&quot;&quot; In-Ground Basketball Hoop with P&quot;|499.99       |1      |
|5                  |96        |Teeter Hang Ups NXT-S Inversion Table           |299.99       |2      |
|5                  |79        |Fitness Gear 300 lb Olympic Weight Set          |209.99       |3      |
|5                  |81        |Quik Shade Summit SX170 10 FT. x 10 FT. Canop   |199.99       |4      |
|5                  |90        |Nike Men&#39;s LeBron XI Basketball Shoe            |199.99       |5      |
+-------------------+----------+------------------------------------------------+-------------+-------+
only showing top 20 rows
</pre></div>
</div>
<p>​</p>
<p><a class="reference external" href="#Table-of-contents">Back to Top</a></p>
</div>
<div class="section" id="rank-and-dense-rank">
<h3>RANK and DENSE_RANK<a class="headerlink" href="#rank-and-dense-rank" title="Permalink to this headline">¶</a></h3>
<p><strong>RANK</strong> gives us the ranking within our ordered partition. Ties are assigned the same rank, with the next ranking(s) skipped. So, if we have 3 items at rank 2, the next rank listed would be ranked 5.</p>
<p><strong>DENSE_RANK</strong> again gives us the ranking within our ordered partition, but the ranks are consecutive. No ranks are skipped if there are ranks with multiple items.</p>
<p>The Following 3 examples plays with the rank(), dense_rank() and row_number() functions.</p>
</div>
<div class="section" id="get-topn-products-by-price-in-each-category">
<h3>4.18 Get topN products by price in each category:<a class="headerlink" href="#get-topn-products-by-price-in-each-category" title="Permalink to this headline">¶</a></h3>
<p><strong>topN: For each product category get the top 5 records. i.e. top 5 ranked products in each category (some of the products may have same price so the top 5 products will all be distinct products but their prices may not be distinct 5. So, the number of distinct prices &lt;= 5 in the top5 but the count distinct products may be &gt;= 5. top 5 ranked products does not necessary mean there will be exactly 5 products may be less or more too.</strong></p>
<p><strong>SQL:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;SELECT product_category_id, product_id, product_name, product_price, rank</span>
<span class="sd">          |FROM ( </span>
<span class="sd">          |     SELECT q.*, RANK() OVER (PARTITION BY q.product_category_id ORDER BY q.product_price DESC) as rank </span>
<span class="sd">          |     FROM products q)</span>
<span class="sd">          |WHERE rank &lt;= 5 </span>
<span class="sd">          |ORDER BY product_category_id, rank</span>
<span class="sd">          |      </span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-------------------+----------+------------------------------------------------+-------------+----+
|product_category_id|product_id|product_name                                    |product_price|rank|
+-------------------+----------+------------------------------------------------+-------------+----+
|2                  |16        |Riddell Youth 360 Custom Football Helmet        |299.99       |1   |
|2                  |11        |Fitness Gear 300 lb Olympic Weight Set          |209.99       |2   |
|2                  |5         |Riddell Youth Revolution Speed Custom Footbal   |199.99       |3   |
|2                  |14        |Quik Shade Summit SX170 10 FT. x 10 FT. Canop   |199.99       |3   |
|2                  |12        |Under Armour Men&#39;s Highlight MC Alter Ego Fla   |139.99       |5   |
|2                  |23        |Under Armour Men&#39;s Highlight MC Alter Ego Hul   |139.99       |5   |
|3                  |40        |Quik Shade Summit SX170 10 FT. x 10 FT. Canop   |199.99       |1   |
|3                  |32        |PUMA Men&#39;s evoPOWER 1 Tricks FG Soccer Cleat    |189.99       |2   |
|3                  |48        |adidas Brazuca Final Rio Official Match Ball    |159.99       |3   |
|3                  |35        |adidas Brazuca 2014 Official Match Ball         |159.99       |3   |
|3                  |46        |Quest 12&#39; x 12&#39; Dome Canopy                     |149.99       |5   |
|4                  |66        |SOLE F85 Treadmill                              |1799.99      |1   |
|4                  |60        |SOLE E25 Elliptical                             |999.99       |2   |
|4                  |71        |Diamondback Adult Response XE Mountain Bike 2   |349.98       |3   |
|4                  |68        |Diamondback Adult Outlook Mountain Bike 2014    |309.99       |4   |
|4                  |61        |Diamondback Girls&#39; Clarity 24 Hybrid Bike 201   |299.99       |5   |
|4                  |58        |Diamondback Boys&#39; Insight 24 Performance Hybr   |299.99       |5   |
|5                  |74        |&quot;Goaliath 54&quot;&quot; In-Ground Basketball Hoop with P&quot;|499.99       |1   |
|5                  |96        |Teeter Hang Ups NXT-S Inversion Table           |299.99       |2   |
|5                  |79        |Fitness Gear 300 lb Olympic Weight Set          |209.99       |3   |
+-------------------+----------+------------------------------------------------+-------------+----+
only showing top 20 rows
</pre></div>
</div>
<p>​</p>
<p><strong>DF API:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">windowSpec</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="n">products_df</span><span class="p">[</span><span class="s1">&#39;product_category_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">products_df</span><span class="p">[</span><span class="s1">&#39;product_price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">top_five_per_ctg</span> <span class="o">=</span> <span class="p">(</span><span class="n">products_df</span>
    <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;product_category_id&#39;</span><span class="p">,</span> <span class="s1">&#39;product_id&#39;</span><span class="p">,</span> <span class="s1">&#39;product_name&#39;</span><span class="p">,</span> <span class="s1">&#39;product_price&#39;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">rank</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">windowSpec</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;rank&#39;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;rank&#39;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span>
    <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s1">&#39;product_category_id&#39;</span><span class="p">,</span> <span class="s1">&#39;rank&#39;</span><span class="p">))</span>
    
<span class="n">top_five_per_ctg</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[product_category_id: int, product_id: int, product_name: string, product_price: float, rank: int]
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">top_five_per_ctg</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-------------------+----------+------------------------------------------------+-------------+----+
|product_category_id|product_id|product_name                                    |product_price|rank|
+-------------------+----------+------------------------------------------------+-------------+----+
|2                  |16        |Riddell Youth 360 Custom Football Helmet        |299.99       |1   |
|2                  |11        |Fitness Gear 300 lb Olympic Weight Set          |209.99       |2   |
|2                  |5         |Riddell Youth Revolution Speed Custom Footbal   |199.99       |3   |
|2                  |14        |Quik Shade Summit SX170 10 FT. x 10 FT. Canop   |199.99       |3   |
|2                  |12        |Under Armour Men&#39;s Highlight MC Alter Ego Fla   |139.99       |5   |
|2                  |23        |Under Armour Men&#39;s Highlight MC Alter Ego Hul   |139.99       |5   |
|3                  |40        |Quik Shade Summit SX170 10 FT. x 10 FT. Canop   |199.99       |1   |
|3                  |32        |PUMA Men&#39;s evoPOWER 1 Tricks FG Soccer Cleat    |189.99       |2   |
|3                  |35        |adidas Brazuca 2014 Official Match Ball         |159.99       |3   |
|3                  |48        |adidas Brazuca Final Rio Official Match Ball    |159.99       |3   |
|3                  |46        |Quest 12&#39; x 12&#39; Dome Canopy                     |149.99       |5   |
|4                  |66        |SOLE F85 Treadmill                              |1799.99      |1   |
|4                  |60        |SOLE E25 Elliptical                             |999.99       |2   |
|4                  |71        |Diamondback Adult Response XE Mountain Bike 2   |349.98       |3   |
|4                  |68        |Diamondback Adult Outlook Mountain Bike 2014    |309.99       |4   |
|4                  |58        |Diamondback Boys&#39; Insight 24 Performance Hybr   |299.99       |5   |
|4                  |61        |Diamondback Girls&#39; Clarity 24 Hybrid Bike 201   |299.99       |5   |
|5                  |74        |&quot;Goaliath 54&quot;&quot; In-Ground Basketball Hoop with P&quot;|499.99       |1   |
|5                  |96        |Teeter Hang Ups NXT-S Inversion Table           |299.99       |2   |
|5                  |79        |Fitness Gear 300 lb Olympic Weight Set          |209.99       |3   |
+-------------------+----------+------------------------------------------------+-------------+----+
only showing top 20 rows
</pre></div>
</div>
<p>​</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#pdf = (top_five_per_ctg</span>
<span class="c1">#       .select(&#39;product_category_id&#39;).limit(25).distinct()</span>
<span class="c1">#       .join(top_five_per_ctg, on=&#39;product_category_id&#39;, how=&#39;inner&#39;)</span>
<span class="c1">#       .orderBy(&#39;product_category_id&#39;, &#39;rank&#39;)).toPandas()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#pdf.head()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#g = (sns.factorplot(x=&quot;product_category_id&quot;, y=&quot;product_price&quot;, hue=&quot;product_name&quot;, data=pdf, kind=&quot;bar&quot;, size=20, </span>
<span class="c1">#        aspect=.7, legend=False));</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#sns.barplot(x=&#39;product_category_id&#39;, y=&#39;product_price&#39;, hue=&#39;product_id&#39;, data=pdf)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">top_five_per_ctg</span><span class="o">.</span><span class="n">unpersist</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[product_category_id: int, product_id: int, product_name: string, product_price: float, rank: int]
</pre></div>
</div>
<p><a class="reference external" href="#Table-of-contents">Back to Top</a></p>
</div>
<div class="section" id="get-topn-priced-products-in-each-category">
<h3>4.19 Get ‘topN priced’ products in each category:<a class="headerlink" href="#get-topn-priced-products-in-each-category" title="Permalink to this headline">¶</a></h3>
<p><strong>topDenseN: For each category get top 5 priced products i.e. if there are 10 products with distinct top 5 prices, the DF should give us all 10 products, so all the products will be distinct as well as we will get 5 different distinct prices too among them.</strong></p>
<p><strong>SQL:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;SELECT product_category_id, product_id, product_name, product_price, dense_rank</span>
<span class="sd">          |FROM ( </span>
<span class="sd">          |     SELECT q.*, dense_rank() OVER (PARTITION BY q.product_category_id ORDER BY q.product_price DESC) as dense_rank </span>
<span class="sd">          |     FROM products q)</span>
<span class="sd">          |WHERE dense_rank &lt;= 5 </span>
<span class="sd">          |ORDER BY product_category_id, dense_rank</span>
<span class="sd">          |      </span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-------------------+----------+------------------------------------------------+-------------+----------+
|product_category_id|product_id|product_name                                    |product_price|dense_rank|
+-------------------+----------+------------------------------------------------+-------------+----------+
|2                  |16        |Riddell Youth 360 Custom Football Helmet        |299.99       |1         |
|2                  |11        |Fitness Gear 300 lb Olympic Weight Set          |209.99       |2         |
|2                  |5         |Riddell Youth Revolution Speed Custom Footbal   |199.99       |3         |
|2                  |14        |Quik Shade Summit SX170 10 FT. x 10 FT. Canop   |199.99       |3         |
|2                  |12        |Under Armour Men&#39;s Highlight MC Alter Ego Fla   |139.99       |4         |
|2                  |23        |Under Armour Men&#39;s Highlight MC Alter Ego Hul   |139.99       |4         |
|2                  |6         |Jordan Men&#39;s VI Retro TD Football Cleat         |134.99       |5         |
|3                  |40        |Quik Shade Summit SX170 10 FT. x 10 FT. Canop   |199.99       |1         |
|3                  |32        |PUMA Men&#39;s evoPOWER 1 Tricks FG Soccer Cleat    |189.99       |2         |
|3                  |35        |adidas Brazuca 2014 Official Match Ball         |159.99       |3         |
|3                  |48        |adidas Brazuca Final Rio Official Match Ball    |159.99       |3         |
|3                  |46        |Quest 12&#39; x 12&#39; Dome Canopy                     |149.99       |4         |
|3                  |31        |Nike+ Fuelband SE                               |99.0         |5         |
|4                  |66        |SOLE F85 Treadmill                              |1799.99      |1         |
|4                  |60        |SOLE E25 Elliptical                             |999.99       |2         |
|4                  |71        |Diamondback Adult Response XE Mountain Bike 2   |349.98       |3         |
|4                  |68        |Diamondback Adult Outlook Mountain Bike 2014    |309.99       |4         |
|4                  |58        |Diamondback Boys&#39; Insight 24 Performance Hybr   |299.99       |5         |
|4                  |61        |Diamondback Girls&#39; Clarity 24 Hybrid Bike 201   |299.99       |5         |
|5                  |74        |&quot;Goaliath 54&quot;&quot; In-Ground Basketball Hoop with P&quot;|499.99       |1         |
+-------------------+----------+------------------------------------------------+-------------+----------+
only showing top 20 rows
</pre></div>
</div>
<p>​</p>
<p><strong>DF API:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">windowSpec</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="n">products_df</span><span class="p">[</span><span class="s1">&#39;product_category_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">products_df</span><span class="p">[</span><span class="s1">&#39;product_price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">products_df</span>
    <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;product_category_id&#39;</span><span class="p">,</span> <span class="s1">&#39;product_id&#39;</span><span class="p">,</span> <span class="s1">&#39;product_name&#39;</span><span class="p">,</span> <span class="s1">&#39;product_price&#39;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">dense_rank</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">windowSpec</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;dense_rank&#39;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;dense_rank&#39;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span>
    <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s1">&#39;product_category_id&#39;</span><span class="p">,</span> <span class="s1">&#39;dense_rank&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-------------------+----------+------------------------------------------------+-------------+----------+
|product_category_id|product_id|product_name                                    |product_price|dense_rank|
+-------------------+----------+------------------------------------------------+-------------+----------+
|2                  |16        |Riddell Youth 360 Custom Football Helmet        |299.99       |1         |
|2                  |11        |Fitness Gear 300 lb Olympic Weight Set          |209.99       |2         |
|2                  |14        |Quik Shade Summit SX170 10 FT. x 10 FT. Canop   |199.99       |3         |
|2                  |5         |Riddell Youth Revolution Speed Custom Footbal   |199.99       |3         |
|2                  |12        |Under Armour Men&#39;s Highlight MC Alter Ego Fla   |139.99       |4         |
|2                  |23        |Under Armour Men&#39;s Highlight MC Alter Ego Hul   |139.99       |4         |
|2                  |6         |Jordan Men&#39;s VI Retro TD Football Cleat         |134.99       |5         |
|3                  |40        |Quik Shade Summit SX170 10 FT. x 10 FT. Canop   |199.99       |1         |
|3                  |32        |PUMA Men&#39;s evoPOWER 1 Tricks FG Soccer Cleat    |189.99       |2         |
|3                  |35        |adidas Brazuca 2014 Official Match Ball         |159.99       |3         |
|3                  |48        |adidas Brazuca Final Rio Official Match Ball    |159.99       |3         |
|3                  |46        |Quest 12&#39; x 12&#39; Dome Canopy                     |149.99       |4         |
|3                  |31        |Nike+ Fuelband SE                               |99.0         |5         |
|4                  |66        |SOLE F85 Treadmill                              |1799.99      |1         |
|4                  |60        |SOLE E25 Elliptical                             |999.99       |2         |
|4                  |71        |Diamondback Adult Response XE Mountain Bike 2   |349.98       |3         |
|4                  |68        |Diamondback Adult Outlook Mountain Bike 2014    |309.99       |4         |
|4                  |61        |Diamondback Girls&#39; Clarity 24 Hybrid Bike 201   |299.99       |5         |
|4                  |58        |Diamondback Boys&#39; Insight 24 Performance Hybr   |299.99       |5         |
|5                  |74        |&quot;Goaliath 54&quot;&quot; In-Ground Basketball Hoop with P&quot;|499.99       |1         |
+-------------------+----------+------------------------------------------------+-------------+----------+
only showing top 20 rows
</pre></div>
</div>
<p>​</p>
<p><a class="reference external" href="#Table-of-contents">Back to Top</a></p>
</div>
<div class="section" id="get-the-customer-id-with-max-revenue-on-daily-basis">
<h3>4.20 Get the Customer Id with max revenue on Daily basis:<a class="headerlink" href="#get-the-customer-id-with-max-revenue-on-daily-basis" title="Permalink to this headline">¶</a></h3>
<p><strong>SQL:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. Join orders and order_items and group by order_date and customer_id to calculate the revenue per customer per day</span>
<span class="c1"># 2. Sort the above using rank() function to get the maximum revenue per day</span>
<span class="c1"># 3. Select only rows with rank = 1, that will give the customer_id with max revenue</span>
<span class="c1"># 4. Join with customers table to get the customer details</span>
<span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;SELECT a. order_date, a.order_customer_id, concat_ws(&#39; &#39;, c.customer_fname, c.customer_lname) as customer_name, a.order_total</span>
<span class="sd">          |FROM ( </span>
<span class="sd">          |     SELECT *, rank() OVER (PARTITION BY b.order_date ORDER BY b.order_total DESC) as rank </span>
<span class="sd">          |     FROM ( </span>
<span class="sd">          |          SELECT o.order_date, o.order_customer_id, round(sum(oi.order_item_subtotal), 2) as order_total </span>
<span class="sd">          |          FROM orders o INNER JOIN order_items oi </span>
<span class="sd">          |              ON o.order_id = oi.order_item_order_id  </span>
<span class="sd">          |          WHERE o.order_status &lt;&gt; &#39;CANCELED&#39; AND o.order_status &lt;&gt; &#39;SUSPECTED_FRAUD&#39; </span>
<span class="sd">          |          GROUP BY o.order_date, o.order_customer_id) b </span>
<span class="sd">          |     ) a INNER JOIN customers c</span>
<span class="sd">          |           ON a.order_customer_id = c.customer_id</span>
<span class="sd">          |WHERE rank = 1 </span>
<span class="sd">          |ORDER BY order_date</span>
<span class="sd">          |      </span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+---------------------+-----------------+----------------+-----------+
|order_date           |order_customer_id|customer_name   |order_total|
+---------------------+-----------------+----------------+-----------+
|2013-07-25 00:00:00.0|11941            |Jeffrey Pugh    |1649.8     |
|2013-07-26 00:00:00.0|32               |Alice Smith     |2009.75    |
|2013-07-27 00:00:00.0|11491            |David Smith     |1379.88    |
|2013-07-28 00:00:00.0|5738             |Mildred Taylor  |1499.87    |
|2013-07-29 00:00:00.0|5182             |Thomas Morgan   |1389.86    |
|2013-07-29 00:00:00.0|2632             |John Smith      |1389.86    |
|2013-07-30 00:00:00.0|10029            |Mary Silva      |1529.92    |
|2013-07-31 00:00:00.0|1175             |Mary Gray       |1699.91    |
|2013-08-01 00:00:00.0|9151             |Aaron Smith     |1709.82    |
|2013-08-02 00:00:00.0|5548             |Michael Crawford|1594.92    |
|2013-08-03 00:00:00.0|9572             |Mary Nelson     |1569.79    |
|2013-08-04 00:00:00.0|2290             |Joe Wright      |1589.86    |
|2013-08-05 00:00:00.0|3938             |Mary Smith      |1419.88    |
|2013-08-06 00:00:00.0|2019             |Pamela Smith    |1529.91    |
|2013-08-07 00:00:00.0|2556             |Samuel Hammond  |1429.87    |
|2013-08-08 00:00:00.0|4960             |Mary Smith      |1359.78    |
|2013-08-09 00:00:00.0|11662            |Mary Smith      |1579.93    |
|2013-08-10 00:00:00.0|11806            |Mildred Hester  |1699.9     |
|2013-08-11 00:00:00.0|7270             |Mary Smith      |1659.86    |
|2013-08-12 00:00:00.0|7565             |Jean Donovan    |1659.86    |
+---------------------+-----------------+----------------+-----------+
only showing top 20 rows
</pre></div>
</div>
<p>​</p>
<p><strong>DF API:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rev_per_day_per_cust</span> <span class="o">=</span> <span class="p">(</span><span class="n">orders_df</span>
                         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;order_date&#39;</span><span class="p">,</span> <span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="s1">&#39;order_customer_id&#39;</span><span class="p">,</span> <span class="s1">&#39;order_status&#39;</span><span class="p">)</span>
                         <span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;order_status&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;CANCELED&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;order_status&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;SUSPECTED_FRAUD&#39;</span><span class="p">))</span>
                         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">order_items_df</span><span class="p">,</span> <span class="n">orders_df</span><span class="o">.</span><span class="n">order_id</span> <span class="o">==</span> <span class="n">order_items_df</span><span class="o">.</span><span class="n">order_item_order_id</span><span class="p">)</span>
                         <span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s1">&#39;order_date&#39;</span><span class="p">,</span> <span class="s1">&#39;order_customer_id&#39;</span><span class="p">,</span> <span class="s1">&#39;order_item_subtotal&#39;</span><span class="p">])</span>
                         <span class="o">.</span><span class="n">groupBy</span><span class="p">([</span><span class="s1">&#39;order_date&#39;</span><span class="p">,</span> <span class="s1">&#39;order_customer_id&#39;</span><span class="p">])</span>
                         <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">&#39;order_item_subtotal&#39;</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;order_total&#39;</span><span class="p">)))</span>

<span class="n">rev_per_day_per_cust</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[order_date: string, order_customer_id: int, order_total: double]
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rev_per_day_per_cust</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+---------------------+-----------------+-----------+
|order_date           |order_customer_id|order_total|
+---------------------+-----------------+-----------+
|2013-07-26 00:00:00.0|7710             |1199.82    |
|2013-07-27 00:00:00.0|1180             |1129.94    |
|2013-07-30 00:00:00.0|5511             |319.97     |
|2013-07-31 00:00:00.0|12018            |347.94     |
|2013-08-03 00:00:00.0|6698             |709.94     |
+---------------------+-----------------+-----------+
only showing top 5 rows
</pre></div>
</div>
<p>​</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">windowSpec</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="n">rev_per_day_per_cust</span><span class="p">[</span><span class="s1">&#39;order_date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">rev_per_day_per_cust</span><span class="p">[</span><span class="s1">&#39;order_total&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">top_cust_per_day_by_rev</span> <span class="o">=</span> <span class="p">(</span><span class="n">rev_per_day_per_cust</span>
                           <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">rank</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">windowSpec</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;rank&#39;</span><span class="p">))</span>
                           <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;rank&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                           <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s1">&#39;order_date&#39;</span><span class="p">))</span>

<span class="n">top_cust_per_day_by_rev</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[order_date: string, order_customer_id: int, order_total: double, rank: int]
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">top_cust_per_day_by_rev</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+---------------------+-----------------+-----------+----+
|order_date           |order_customer_id|order_total|rank|
+---------------------+-----------------+-----------+----+
|2013-07-25 00:00:00.0|11941            |1649.8     |1   |
|2013-07-26 00:00:00.0|32               |2009.75    |1   |
|2013-07-27 00:00:00.0|11491            |1379.88    |1   |
|2013-07-28 00:00:00.0|5738             |1499.87    |1   |
|2013-07-29 00:00:00.0|2632             |1389.86    |1   |
+---------------------+-----------------+-----------+----+
only showing top 5 rows
</pre></div>
</div>
<p>​</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">top_cust_per_day_by_rev</span>
 <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">customers_df</span><span class="p">,</span> <span class="n">top_cust_per_day_by_rev</span><span class="o">.</span><span class="n">order_customer_id</span> <span class="o">==</span> <span class="n">customers_df</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
 <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;order_date&#39;</span><span class="p">,</span> <span class="s1">&#39;order_customer_id&#39;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">concat_ws</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;customer_fname&#39;</span><span class="p">,</span> <span class="s1">&#39;customer_lname&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;customer_name&#39;</span><span class="p">),</span> <span class="s1">&#39;order_total&#39;</span><span class="p">)</span>
 <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+---------------------+-----------------+----------------+-----------+
|order_date           |order_customer_id|customer_name   |order_total|
+---------------------+-----------------+----------------+-----------+
|2013-07-26 00:00:00.0|32               |Alice Smith     |2009.75    |
|2014-07-03 00:00:00.0|41               |Victoria Mason  |1649.87    |
|2014-04-27 00:00:00.0|53               |Katherine Smith |1579.86    |
|2014-01-02 00:00:00.0|58               |Michael Edwards |1389.77    |
|2013-11-19 00:00:00.0|142              |Heather Smith   |1499.92    |
|2014-02-18 00:00:00.0|154              |Emily May       |1539.86    |
|2013-09-30 00:00:00.0|172              |Lauren Rush     |1579.76    |
|2014-06-26 00:00:00.0|187              |Mildred Herrera |1499.88    |
|2013-10-24 00:00:00.0|242              |Mary Stein      |1899.9     |
|2013-09-02 00:00:00.0|247              |Angela Smith    |1529.89    |
|2013-09-07 00:00:00.0|294              |Mary Smith      |1659.82    |
|2014-05-08 00:00:00.0|371              |Adam Marquez    |1449.95    |
|2014-02-04 00:00:00.0|373              |George Sandoval |1339.89    |
|2013-12-10 00:00:00.0|382              |Mary Lane       |2699.9     |
|2013-09-17 00:00:00.0|410              |Jack Moore      |1499.82    |
|2013-09-03 00:00:00.0|437              |Cynthia Benjamin|1399.86    |
|2014-05-31 00:00:00.0|531              |Paul Burns      |1509.83    |
|2013-09-01 00:00:00.0|543              |Alice Lucero    |1489.83    |
|2013-11-08 00:00:00.0|548              |Ryan Horton     |1978.77    |
|2014-05-02 00:00:00.0|578              |Dylan Knapp     |1559.78    |
+---------------------+-----------------+----------------+-----------+
only showing top 20 rows
</pre></div>
</div>
<p>​</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rev_per_day_per_cust</span><span class="o">.</span><span class="n">unpersist</span><span class="p">()</span>
<span class="n">top_cust_per_day_by_rev</span><span class="o">.</span><span class="n">unpersist</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[order_date: string, order_customer_id: int, order_total: double]






DataFrame[order_date: string, order_customer_id: int, order_total: double, rank: int]
</pre></div>
</div>
<p><a class="reference external" href="#Table-of-contents">Back to Top</a></p>
</div>
<div class="section" id="get-the-top-3-max-revenue-generating-customers-per-month-in-2013">
<h3>4.21 Get the top 3 Max Revenue Generating Customers Per Month in 2013:<a class="headerlink" href="#get-the-top-3-max-revenue-generating-customers-per-month-in-2013" title="Permalink to this headline">¶</a></h3>
<p><strong>SQL:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Map from month number to actual month string</span>
<span class="n">monthmap</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span><span class="s2">&quot;Jan&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="s2">&quot;Feb&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="s2">&quot;Mar&quot;</span><span class="p">,</span>  <span class="mi">4</span><span class="p">:</span><span class="s2">&quot;Apr&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span><span class="s2">&quot;May&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span><span class="s2">&quot;Jun&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">:</span><span class="s2">&quot;Jul&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">:</span><span class="s2">&quot;Aug&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">:</span><span class="s2">&quot;Sep&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span><span class="s2">&quot;Oct&quot;</span><span class="p">,</span> <span class="mi">11</span><span class="p">:</span><span class="s2">&quot;Nov&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span><span class="s2">&quot;Dec&quot;</span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in order to use an udf with sql it needs to be registerd to sqlContext</span>
<span class="n">sqlContext</span><span class="o">.</span><span class="n">udf</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;udfmonTomonth&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">monthmap</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">StringType</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;function __main__.&lt;lambda&gt;&gt;
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. Join orders and order_items and group by order_month and customer_id to calculate the revenue per customer per month</span>
<span class="c1"># 2. Sort the above using dense_rank() function to get the maximum revenue per month</span>
<span class="c1"># 3. Join with customers table to get the customer details</span>
<span class="c1"># 4. Select only rows with rank &lt;= 1, that will give the top 3 customers with max revenue</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;SELECT a.order_month, CONCAT_WS(&#39; &#39;, c.customer_fname, c.customer_lname) as customer_name, a.order_total, a.dense_rank</span>
<span class="sd">          |FROM ( </span>
<span class="sd">          |     SELECT *, DENSE_RANK() OVER (PARTITION BY order_month ORDER BY order_total DESC) as dense_rank </span>
<span class="sd">          |     FROM ( </span>
<span class="sd">          |          SELECT udfmonTomonth(MONTH(o.order_date)) as order_month, o.order_customer_id, ROUND(SUM(oi.order_item_subtotal), 2) as order_total </span>
<span class="sd">          |          FROM orders o INNER JOIN order_items oi </span>
<span class="sd">          |              ON o.order_id = oi.order_item_order_id  </span>
<span class="sd">          |          WHERE o.order_status &lt;&gt; &#39;CANCELED&#39; AND o.order_status &lt;&gt; &#39;SUSPECTED_FRAUD&#39; </span>
<span class="sd">          |          AND YEAR(o.order_date) = 2013</span>
<span class="sd">          |          GROUP BY order_month, o.order_customer_id) </span>
<span class="sd">          |     ) a  INNER JOIN customers c</span>
<span class="sd">          |         ON a.order_customer_id = c.customer_id</span>
<span class="sd">          |WHERE dense_rank &lt;= 3 </span>
<span class="sd">          |ORDER BY order_month, dense_rank</span>
<span class="sd">          |      </span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">))</span>

<span class="n">df</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[order_month: string, customer_name: string, order_total: double, dense_rank: int]
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-----------+-----------------+-----------+----------+
|order_month|customer_name    |order_total|dense_rank|
+-----------+-----------------+-----------+----------+
|Aug        |Victoria Smith   |4229.84    |1         |
|Aug        |Shirley Whitehead|3649.66    |2         |
|Aug        |Mary Smith       |3571.73    |3         |
|Dec        |Mary Olson       |4029.61    |1         |
|Dec        |Ann Smith        |3497.69    |2         |
|Dec        |Janet Smith      |3179.68    |3         |
|Jul        |Michelle Callahan|2781.73    |1         |
|Jul        |William Smith    |2059.75    |2         |
|Jul        |Alice Smith      |2009.75    |3         |
|Nov        |David Smith      |3129.72    |1         |
|Nov        |Rachel Smith     |3019.76    |2         |
|Nov        |Robert Williams  |2989.74    |3         |
|Oct        |Diana Smith      |3479.64    |1         |
|Oct        |Mary Smith       |2959.77    |2         |
|Oct        |Mary Smith       |2859.75    |3         |
|Sep        |Nicholas Smith   |3309.62    |1         |
|Sep        |Mary Rodriguez   |3233.62    |2         |
|Sep        |Kevin Smith      |3134.56    |3         |
+-----------+-----------------+-----------+----------+
</pre></div>
</div>
<p>​</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">unpersist</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[order_month: string, customer_name: string, order_total: double, dense_rank: int]
</pre></div>
</div>
<p><strong>DF API:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Map from month number to actual month string</span>
<span class="n">monthmap</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span><span class="s2">&quot;Jan&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="s2">&quot;Feb&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="s2">&quot;Mar&quot;</span><span class="p">,</span>  <span class="mi">4</span><span class="p">:</span><span class="s2">&quot;Apr&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span><span class="s2">&quot;May&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span><span class="s2">&quot;Jun&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">:</span><span class="s2">&quot;Jul&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">:</span><span class="s2">&quot;Aug&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">:</span><span class="s2">&quot;Sep&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">:</span><span class="s2">&quot;Oct&quot;</span><span class="p">,</span> <span class="mi">11</span><span class="p">:</span><span class="s2">&quot;Nov&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span><span class="s2">&quot;Dec&quot;</span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define a udf</span>
<span class="n">udfmonTomonth</span> <span class="o">=</span> <span class="n">udf</span><span class="p">(</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">monthmap</span><span class="p">[</span><span class="n">m</span><span class="p">],</span> <span class="n">StringType</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rev_per_month_per_cust</span> <span class="o">=</span> <span class="p">(</span><span class="n">orders_df</span>
                         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">udfmonTomonth</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">month</span><span class="p">(</span><span class="s1">&#39;order_date&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;order_month&#39;</span><span class="p">),</span> <span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="s1">&#39;order_customer_id&#39;</span><span class="p">,</span> <span class="s1">&#39;order_status&#39;</span><span class="p">)</span>
                         <span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;order_status&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;CANCELED&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;order_status&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;SUSPECTED_FRAUD&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">year</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;order_date&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2013</span><span class="p">))</span>
                         <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">order_items_df</span><span class="p">,</span> <span class="n">orders_df</span><span class="o">.</span><span class="n">order_id</span> <span class="o">==</span> <span class="n">order_items_df</span><span class="o">.</span><span class="n">order_item_order_id</span><span class="p">)</span>
                         <span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s1">&#39;order_month&#39;</span><span class="p">,</span> <span class="s1">&#39;order_customer_id&#39;</span><span class="p">,</span> <span class="s1">&#39;order_item_subtotal&#39;</span><span class="p">])</span>
                         <span class="o">.</span><span class="n">groupBy</span><span class="p">([</span><span class="s1">&#39;order_month&#39;</span><span class="p">,</span> <span class="s1">&#39;order_customer_id&#39;</span><span class="p">])</span>
                         <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">&#39;order_item_subtotal&#39;</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;order_total&#39;</span><span class="p">)))</span>

<span class="n">rev_per_month_per_cust</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[order_month: string, order_customer_id: int, order_total: double]
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rev_per_month_per_cust</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-----------+-----------------+-----------+
|order_month|order_customer_id|order_total|
+-----------+-----------------+-----------+
|Jul        |4840             |129.99     |
|Jul        |8504             |1279.65    |
|Jul        |7436             |399.96     |
|Jul        |3752             |599.95     |
|Jul        |9639             |129.99     |
+-----------+-----------------+-----------+
only showing top 5 rows
</pre></div>
</div>
<p>​</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">windowSpec</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="n">rev_per_month_per_cust</span><span class="p">[</span><span class="s1">&#39;order_month&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">rev_per_month_per_cust</span><span class="p">[</span><span class="s1">&#39;order_total&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">top_cust_per_month_by_rev</span> <span class="o">=</span> <span class="p">(</span><span class="n">rev_per_month_per_cust</span>
                           <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">dense_rank</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">windowSpec</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;dense_rank&#39;</span><span class="p">))</span>
                           <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;dense_rank&#39;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span>
                           <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s1">&#39;order_month&#39;</span><span class="p">))</span>

<span class="n">top_cust_per_month_by_rev</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[order_month: string, order_customer_id: int, order_total: double, dense_rank: int]
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">top_cust_per_month_by_rev</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-----------+-----------------+-----------+----------+
|order_month|order_customer_id|order_total|dense_rank|
+-----------+-----------------+-----------+----------+
|Aug        |9515             |4229.84    |1         |
|Aug        |5047             |3649.66    |2         |
|Aug        |791              |3571.73    |3         |
|Dec        |9586             |4029.61    |1         |
|Dec        |10291            |3497.69    |2         |
+-----------+-----------------+-----------+----------+
only showing top 5 rows
</pre></div>
</div>
<p>​</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">top_cust_per_month_by_rev</span>
 <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">customers_df</span><span class="p">,</span> <span class="n">top_cust_per_month_by_rev</span><span class="o">.</span><span class="n">order_customer_id</span> <span class="o">==</span> <span class="n">customers_df</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
 <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;order_month&#39;</span><span class="p">,</span> <span class="s1">&#39;order_customer_id&#39;</span><span class="p">,</span> 
         <span class="n">F</span><span class="o">.</span><span class="n">concat_ws</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;customer_fname&#39;</span><span class="p">,</span> <span class="s1">&#39;customer_lname&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;customer_name&#39;</span><span class="p">),</span> 
         <span class="s1">&#39;order_total&#39;</span><span class="p">,</span> <span class="s1">&#39;dense_rank&#39;</span><span class="p">)</span>
 <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-----------+-----------------+-----------------+-----------+----------+
|order_month|order_customer_id|customer_name    |order_total|dense_rank|
+-----------+-----------------+-----------------+-----------+----------+
|Jul        |32               |Alice Smith      |2009.75    |3         |
|Aug        |791              |Mary Smith       |3571.73    |3         |
|Oct        |2389             |Mary Smith       |2859.75    |3         |
|Nov        |2740             |Robert Williams  |2989.74    |3         |
|Jul        |4257             |William Smith    |2059.75    |2         |
|Dec        |4781             |Janet Smith      |3179.68    |3         |
|Aug        |5047             |Shirley Whitehead|3649.66    |2         |
|Jul        |5293             |Michelle Callahan|2781.73    |1         |
|Sep        |5560             |Mary Rodriguez   |3233.62    |2         |
|Nov        |5683             |Rachel Smith     |3019.76    |2         |
|Sep        |6643             |Nicholas Smith   |3309.62    |1         |
|Nov        |7305             |David Smith      |3129.72    |1         |
|Aug        |9515             |Victoria Smith   |4229.84    |1         |
|Dec        |9586             |Mary Olson       |4029.61    |1         |
|Dec        |10291            |Ann Smith        |3497.69    |2         |
|Oct        |10567            |Diana Smith      |3479.64    |1         |
|Oct        |10653            |Mary Smith       |2959.77    |2         |
|Sep        |11516            |Kevin Smith      |3134.56    |3         |
+-----------+-----------------+-----------------+-----------+----------+
</pre></div>
</div>
<p>​</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rev_per_month_per_cust</span><span class="o">.</span><span class="n">unpersist</span><span class="p">()</span>
<span class="n">top_cust_per_month_by_rev</span><span class="o">.</span><span class="n">unpersist</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[order_month: string, order_customer_id: int, order_total: double]






DataFrame[order_month: string, order_customer_id: int, order_total: double, dense_rank: int]
</pre></div>
</div>
<p><a class="reference external" href="#Table-of-contents">Back to Top</a></p>
</div>
<div class="section" id="get-all-distinct-pair-of-products-the-occurred-in-orders-where-order-total-was-greater-than-300">
<h3>4.22 Get All Distinct Pair of Products the occurred in Orders where order total was greater than 300:<a class="headerlink" href="#get-all-distinct-pair-of-products-the-occurred-in-orders-where-order-total-was-greater-than-300" title="Permalink to this headline">¶</a></h3>
<p>This problem can be solved using Self Join. But there are some corner cases:</p>
<ul class="simple">
<li><p>Pair (a, b) and (b, a) are same, so they should not be reported twice.</p></li>
<li><p>What happens if item is order more than once in the same order id? i.e. product a appears more than once in the line items of the order id?</p></li>
</ul>
<p>Let’s check our fictitious dataset from Cloudera of order items.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;SELECT order_item_order_id, order_item_product_id, order_item_quantity, order_item_subtotal</span>
<span class="sd">          |FROM order_items oi</span>
<span class="sd">          |ORDER BY order_item_order_id, order_item_product_id</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-------------------+---------------------+-------------------+-------------------+
|order_item_order_id|order_item_product_id|order_item_quantity|order_item_subtotal|
+-------------------+---------------------+-------------------+-------------------+
|                  1|                  957|                  1|             299.98|
|                  2|                  403|                  1|             129.99|
|                  2|                  502|                  5|              250.0|
|                  2|                 1073|                  1|             199.99|
|                  4|                  365|                  5|             299.95|
|                  4|                  502|                  3|              150.0|
|                  4|                  897|                  2|              49.98|
|                  4|                 1014|                  4|             199.92|
|                  5|                  365|                  5|             299.95|
|                  5|                  403|                  1|             129.99|
+-------------------+---------------------+-------------------+-------------------+
only showing top 10 rows
</pre></div>
</div>
<p>​</p>
<p><strong>Corner Case:</strong></p>
<p>Let’s check an order where the same item is ordered twice in a single order. Here in order_id 148 we have product_id 502 ordered twice albeit with different quantities.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;SELECT order_item_order_id, order_item_product_id, order_item_quantity, order_item_subtotal</span>
<span class="sd">          |FROM order_items oi </span>
<span class="sd">          |WHERE oi.order_item_order_id = 148</span>
<span class="sd">          |ORDER BY order_item_product_id</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-------------------+---------------------+-------------------+-------------------+
|order_item_order_id|order_item_product_id|order_item_quantity|order_item_subtotal|
+-------------------+---------------------+-------------------+-------------------+
|                148|                  403|                  1|             129.99|
|                148|                  502|                  2|              100.0|
|                148|                  502|                  5|              250.0|
+-------------------+---------------------+-------------------+-------------------+
</pre></div>
</div>
<p>​</p>
<p><strong>SQL:</strong></p>
<p>Create self join between order_items table and filtered out order_items table where order_total &gt;= 300. Moreover, The sql <em><code class="docutils literal notranslate"><span class="pre">AND</span> <span class="pre">t1.order_item_product_id</span> <span class="pre">&lt;</span> <span class="pre">t2.order_item_product_id</span></code></em> will ensure that pair (a, b) and (b, a) are treated as same and are not reported twice.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">strip_margin</span><span class="p">(</span>
        <span class="sd">&quot;&quot;&quot;SELECT DISTINCT a.order_item_order_id as txn_id, t1.order_item_product_id as prd_a, t2.order_item_product_id as prd_b, ROUND(a.order_total, 2) as txn_total</span>
<span class="sd">          |FROM (</span>
<span class="sd">          |    SELECT order_item_order_id, SUM(order_item_subtotal) as order_total</span>
<span class="sd">          |    FROM order_items</span>
<span class="sd">          |    GROUP BY order_item_order_id) a, </span>
<span class="sd">          |    order_items t1,</span>
<span class="sd">          |    order_items t2</span>
<span class="sd">          |WHERE a.order_total &gt;= 300</span>
<span class="sd">          |AND t1.order_item_order_id = a.order_item_order_id</span>
<span class="sd">          |AND t2.order_item_order_id = a.order_item_order_id</span>
<span class="sd">          |AND t1.order_item_product_id &lt; t2.order_item_product_id</span>
<span class="sd">          |ORDER BY txn_id, prd_a</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+------+-----+-----+---------+
|txn_id|prd_a|prd_b|txn_total|
+------+-----+-----+---------+
|     2|  403|  502|   579.98|
|     2|  403| 1073|   579.98|
|     2|  502| 1073|   579.98|
|     4|  365|  897|   699.85|
|     4|  365| 1014|   699.85|
|     4|  365|  502|   699.85|
|     4|  502|  897|   699.85|
|     4|  502| 1014|   699.85|
|     4|  897| 1014|   699.85|
|     5|  365| 1014|  1129.86|
|     5|  365|  403|  1129.86|
|     5|  365|  957|  1129.86|
|     5|  403| 1014|  1129.86|
|     5|  403|  957|  1129.86|
|     5|  957| 1014|  1129.86|
|     7|  926|  957|   579.92|
|     7|  926| 1073|   579.92|
|     7|  957| 1073|   579.92|
|     8|  365| 1014|   729.84|
|     8|  365|  502|   729.84|
+------+-----+-----+---------+
only showing top 20 rows
</pre></div>
</div>
<p>​</p>
<p><strong>DF API:</strong></p>
<p>Doing the same thing as above but this time using DataFrame APIs instead of SQL.</p>
<p>Note: the usage of alias method on dataframe itself for self joins.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">t1</span> <span class="o">=</span> <span class="n">order_items_df</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;t1&quot;</span><span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">order_items_df</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;t2&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">order_items_df</span>
      <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="n">order_items_df</span><span class="o">.</span><span class="n">order_item_order_id</span><span class="p">)</span>
      <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">order_items_df</span><span class="o">.</span><span class="n">order_item_subtotal</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;order_total&#39;</span><span class="p">))</span>
      <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;order_total&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">300</span><span class="p">)</span>
      <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s1">&#39;t1.order_item_order_id&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">order_items_df</span><span class="o">.</span><span class="n">order_item_order_id</span><span class="p">)</span>
      <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s1">&#39;t2.order_item_order_id&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">order_items_df</span><span class="o">.</span><span class="n">order_item_order_id</span><span class="p">)</span>
      <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;t1.order_item_product_id&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">col</span><span class="p">(</span><span class="s1">&#39;t2.order_item_product_id&#39;</span><span class="p">))</span>
      <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">order_items_df</span><span class="o">.</span><span class="n">order_item_order_id</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;txn_id&#39;</span><span class="p">),</span> 
              <span class="n">col</span><span class="p">(</span><span class="s1">&#39;t1.order_item_product_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;prd_a&#39;</span><span class="p">),</span> 
              <span class="n">col</span><span class="p">(</span><span class="s1">&#39;t2.order_item_product_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;prd_b&#39;</span><span class="p">),</span>
              <span class="n">F</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="s1">&#39;order_total&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;txn_total&#39;</span><span class="p">))</span>
      <span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
      <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s1">&#39;txn_id&#39;</span><span class="p">,</span> <span class="s1">&#39;prd_a&#39;</span><span class="p">))</span>

<span class="n">df</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[txn_id: int, prd_a: int, prd_b: int, txn_total: double]
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+------+-----+-----+---------+
|txn_id|prd_a|prd_b|txn_total|
+------+-----+-----+---------+
|     2|  403|  502|   579.98|
|     2|  403| 1073|   579.98|
|     2|  502| 1073|   579.98|
|     4|  365| 1014|   699.85|
|     4|  365|  897|   699.85|
|     4|  365|  502|   699.85|
|     4|  502|  897|   699.85|
|     4|  502| 1014|   699.85|
|     4|  897| 1014|   699.85|
|     5|  365|  957|  1129.86|
|     5|  365| 1014|  1129.86|
|     5|  365|  403|  1129.86|
|     5|  403|  957|  1129.86|
|     5|  403| 1014|  1129.86|
|     5|  957| 1014|  1129.86|
|     7|  926|  957|   579.92|
|     7|  926| 1073|   579.92|
|     7|  957| 1073|   579.92|
|     8|  365| 1014|   729.84|
|     8|  365|  502|   729.84|
+------+-----+-----+---------+
only showing top 20 rows
</pre></div>
</div>
<p>​</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">unpersist</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DataFrame[txn_id: int, prd_a: int, prd_b: int, txn_total: double]
</pre></div>
</div>
<p><a class="reference external" href="#Table-of-contents">Back to Top</a></p>
</div>
<div class="section" id="get-all-customers-who-didn-t-place-an-order-in-august-2013">
<h3>4.23 Get All Customers who didn’t place an order in August 2013:<a class="headerlink" href="#get-all-customers-who-didn-t-place-an-order-in-august-2013" title="Permalink to this headline">¶</a></h3>
<p><strong>SQL:</strong></p>
<p>This kind of <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">IN</span></code> scenarios can be solved using <code class="docutils literal notranslate"><span class="pre">LEFT</span> <span class="pre">ANTI</span> <span class="pre">JOIN</span></code>. <code class="docutils literal notranslate"><span class="pre">LEFT</span> <span class="pre">ANTI</span> <span class="pre">JOIN</span></code> do not actually include any values from the right DataFrame. They only compare values to see if the value exists in the right DataFrame. However, rather than keeping the values that exist in the right DataFrame, they keep only the values that <code class="docutils literal notranslate"><span class="pre">do</span> <span class="pre">not</span></code> have a corresponding key in the right DataFrame. Think of <code class="docutils literal notranslate"><span class="pre">anti</span> <span class="pre">joins</span></code> as a <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">IN</span></code> SQL style filter.</p>
<p>First, let’s see how the customer data looks like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;select customer_id, customer_fname, customer_lname from customers&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-----------+--------------+--------------+
|customer_id|customer_fname|customer_lname|
+-----------+--------------+--------------+
|          1|       Richard|     Hernandez|
|          2|          Mary|       Barrett|
|          3|           Ann|         Smith|
|          4|          Mary|         Jones|
|          5|        Robert|        Hudson|
|          6|          Mary|         Smith|
|          7|       Melissa|        Wilcox|
|          8|         Megan|         Smith|
|          9|          Mary|         Perez|
|         10|       Melissa|         Smith|
+-----------+--------------+--------------+
only showing top 10 rows
</pre></div>
</div>
<p>​</p>
<p>Second, let’s see which all customers placed ordes in August 2013:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT o.order_customer_id, o.order_id, o.order_date</span>
<span class="s2">            FROM orders o </span>
<span class="s2">            WHERE o.order_status &lt;&gt; &#39;CANCELED&#39; AND o.order_status &lt;&gt; &#39;SUSPECTED_FRAUD&#39;</span>
<span class="s2">            AND YEAR(o.order_date) = 2013</span>
<span class="s2">            AND MONTH(o.order_date) = 8</span>
<span class="s2">         &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-----------------+--------+---------------------+
|order_customer_id|order_id|order_date           |
+-----------------+--------+---------------------+
|11607            |1297    |2013-08-01 00:00:00.0|
|5105             |1298    |2013-08-01 00:00:00.0|
|7802             |1299    |2013-08-01 00:00:00.0|
|553              |1300    |2013-08-01 00:00:00.0|
|1604             |1301    |2013-08-01 00:00:00.0|
|1695             |1302    |2013-08-01 00:00:00.0|
|7018             |1303    |2013-08-01 00:00:00.0|
|2059             |1304    |2013-08-01 00:00:00.0|
|3844             |1305    |2013-08-01 00:00:00.0|
|11672            |1306    |2013-08-01 00:00:00.0|
+-----------------+--------+---------------------+
only showing top 10 rows
</pre></div>
</div>
<p>​</p>
<p>Third, Use <code class="docutils literal notranslate"><span class="pre">LEFT</span> <span class="pre">ANTI</span> <span class="pre">JOIN</span></code> combining both the queries above to find which customers did not place any order in August 2013:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;select distinct order_status from orders&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+---------------+
|   order_status|
+---------------+
|PENDING_PAYMENT|
|       COMPLETE|
|        ON_HOLD|
| PAYMENT_REVIEW|
|     PROCESSING|
|         CLOSED|
|SUSPECTED_FRAUD|
|        PENDING|
|       CANCELED|
+---------------+
</pre></div>
</div>
<p>​</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT customer_id, CONCAT_WS(&#39; &#39;, customer_fname, customer_lname) as customer_name</span>
<span class="s2">        FROM customers A </span>
<span class="s2">            LEFT ANTI JOIN (</span>
<span class="s2">                SELECT o.order_customer_id, o.order_id, o.order_date</span>
<span class="s2">                FROM orders o INNER JOIN order_items oi </span>
<span class="s2">                    ON o.order_id = oi.order_item_order_id </span>
<span class="s2">                WHERE o.order_status &lt;&gt; &#39;CANCELED&#39; AND o.order_status &lt;&gt; &#39;SUSPECTED_FRAUD&#39;</span>
<span class="s2">                AND YEAR(o.order_date) = 2013</span>
<span class="s2">                AND MONTH(o.order_date) = 8) B </span>
<span class="s2">            on A.customer_id = B.order_customer_id</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-----------+------------------+
|customer_id|     customer_name|
+-----------+------------------+
|        148|Stephanie Richards|
|        463|       Harry Smith|
|        471|       Helen Smith|
|        496|        Mary Allen|
|        833|   Alexander Smith|
|       1088|     Zachary Smith|
|       1238|     Angela Massey|
|       1342|      Laura Savage|
|       1580|     Kelly Simmons|
|       1591|   Charles Johnson|
+-----------+------------------+
only showing top 10 rows
</pre></div>
</div>
<p>​</p>
<p>Fourth, Verify with a customer from our result set that he indeed did not place any order in August 2013:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT o.order_customer_id, o.order_id, o.order_date</span>
<span class="s2">            FROM orders o INNER JOIN order_items oi </span>
<span class="s2">                ON o.order_id = oi.order_item_order_id </span>
<span class="s2">            WHERE o.order_status &lt;&gt; &#39;CANCELED&#39; AND o.order_status &lt;&gt; &#39;SUSPECTED_FRAUD&#39;</span>
<span class="s2">            AND YEAR(o.order_date) = 2013</span>
<span class="s2">            AND MONTH(o.order_date) = 8</span>
<span class="s2">            AND o.order_customer_id = 148</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-----------------+--------+----------+
|order_customer_id|order_id|order_date|
+-----------------+--------+----------+
+-----------------+--------+----------+
</pre></div>
</div>
<p>​</p>
<p><strong>DF API:</strong></p>
<p>Doing the same thing as above but this time using DataFrame APIs instead of SQL.</p>
<p>Note: the usage of join expression and join type.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">customers_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">(</span><span class="n">orders_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;order_customer_id&#39;</span><span class="p">,</span> <span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="s1">&#39;order_date&#39;</span><span class="p">)</span>
          <span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;order_status&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;CANCELED&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;order_status&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;SUSPECTED_FRAUD&#39;</span><span class="p">))</span>
          <span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">F</span><span class="o">.</span><span class="n">year</span><span class="p">(</span><span class="s1">&#39;order_date&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2013</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">month</span><span class="p">(</span><span class="s1">&#39;order_date&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span><span class="p">))</span>
          <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">order_items_df</span><span class="p">,</span> <span class="p">[</span><span class="n">orders_df</span><span class="o">.</span><span class="n">order_id</span> <span class="o">==</span> <span class="n">order_items_df</span><span class="o">.</span><span class="n">order_item_order_id</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
          <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;order_customer_id&#39;</span><span class="p">,</span> <span class="s1">&#39;order_id&#39;</span><span class="p">,</span> <span class="s1">&#39;order_date&#39;</span><span class="p">)),</span>
         <span class="p">[</span><span class="n">customers_df</span><span class="o">.</span><span class="n">customer_id</span> <span class="o">==</span> <span class="n">orders_df</span><span class="o">.</span><span class="n">order_customer_id</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left_anti&#39;</span><span class="p">)</span>
         <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;customer_id&#39;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">concat_ws</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;customer_fname&#39;</span><span class="p">,</span> <span class="s1">&#39;customer_lname&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;customer_name&#39;</span><span class="p">))</span>
        <span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-----------+------------------+
|customer_id|     customer_name|
+-----------+------------------+
|        148|Stephanie Richards|
|        463|       Harry Smith|
|        471|       Helen Smith|
|        496|        Mary Allen|
|        833|   Alexander Smith|
|       1088|     Zachary Smith|
|       1238|     Angela Massey|
|       1342|      Laura Savage|
|       1580|     Kelly Simmons|
|       1591|   Charles Johnson|
+-----------+------------------+
only showing top 10 rows
</pre></div>
</div>
<p>​</p>
<p><a class="reference external" href="#Table-of-contents">Back to Top</a></p>
</div>
<div class="section" id="get-all-customers-who-placed-more-than-5-orders-in-august-2013">
<h3>4.24 Get All Customers who placed more than 5 orders in August 2013:<a class="headerlink" href="#get-all-customers-who-placed-more-than-5-orders-in-august-2013" title="Permalink to this headline">¶</a></h3>
<p><strong>SQL:</strong></p>
<p>We can also leverage <code class="docutils literal notranslate"><span class="pre">HAVING</span></code> clause here to filter out based on grouped counts.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT c.customer_id, c.customer_fname, c.customer_lname, count(o.order_id) AS order_count</span>
<span class="s2">            FROM orders o  </span>
<span class="s2">                INNER JOIN order_items oi ON o.order_id = oi.order_item_order_id</span>
<span class="s2">                INNER JOIN customers c ON o.order_customer_id = c.customer_id</span>
<span class="s2">            WHERE o.order_status &lt;&gt; &#39;CANCELED&#39; AND o.order_status &lt;&gt; &#39;SUSPECTED_FRAUD&#39;</span>
<span class="s2">            AND YEAR(o.order_date) = 2013</span>
<span class="s2">            AND MONTH(o.order_date) = 8</span>
<span class="s2">            GROUP BY c.customer_id, c.customer_fname, c.customer_lname</span>
<span class="s2">            HAVING order_count &gt; 5</span>
<span class="s2">            ORDER BY order_count DESC, customer_id</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-----------+--------------+--------------+-----------+
|customer_id|customer_fname|customer_lname|order_count|
+-----------+--------------+--------------+-----------+
|        791|          Mary|         Smith|         15|
|       5047|       Shirley|     Whitehead|         14|
|       5477|          Mary|         Smith|         14|
|       6088|          Mary|        Brooks|         14|
|       9371|          Mary|     Patterson|         14|
|       3295|         Maria|        Joseph|         13|
|       3536|          Mary|        Tanner|         13|
|       4582|         Brian|         House|         13|
|       5865|         David|     Middleton|         13|
|       8069|       Tiffany|      Mcdaniel|         13|
+-----------+--------------+--------------+-----------+
only showing top 10 rows
</pre></div>
</div>
<p>​</p>
<p><strong>DF API:</strong></p>
<p>Note: There is no <code class="docutils literal notranslate"><span class="pre">HAVING</span></code> equivalent in DataFrame APIs. We can use the traditional <code class="docutils literal notranslate"><span class="pre">where</span></code> clause.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">orders_df</span><span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;order_status&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;CANCELED&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;order_status&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;SUSPECTED_FRAUD&#39;</span><span class="p">))</span>
  <span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">F</span><span class="o">.</span><span class="n">year</span><span class="p">(</span><span class="s1">&#39;order_date&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2013</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">month</span><span class="p">(</span><span class="s1">&#39;order_date&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span><span class="p">))</span>
  <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">order_items_df</span><span class="p">,</span> <span class="p">[</span><span class="n">orders_df</span><span class="o">.</span><span class="n">order_id</span> <span class="o">==</span> <span class="n">order_items_df</span><span class="o">.</span><span class="n">order_item_order_id</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
  <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">customers_df</span><span class="p">,</span> <span class="p">[</span><span class="n">orders_df</span><span class="o">.</span><span class="n">order_customer_id</span> <span class="o">==</span> <span class="n">customers_df</span><span class="o">.</span><span class="n">customer_id</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
  <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">customers_df</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">customers_df</span><span class="o">.</span><span class="n">customer_fname</span><span class="p">,</span> <span class="n">customers_df</span><span class="o">.</span><span class="n">customer_lname</span><span class="p">,</span><span class="n">orders_df</span><span class="o">.</span><span class="n">order_id</span><span class="p">)</span>
  <span class="o">.</span><span class="n">groupBy</span><span class="p">([</span><span class="n">customers_df</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">customers_df</span><span class="o">.</span><span class="n">customer_fname</span><span class="p">,</span> <span class="n">customers_df</span><span class="o">.</span><span class="n">customer_lname</span><span class="p">])</span>
  <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">orders_df</span><span class="o">.</span><span class="n">order_id</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;order_count&#39;</span><span class="p">))</span>
  <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;order_count&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
  <span class="o">.</span><span class="n">orderBy</span><span class="p">([</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;order_count&#39;</span><span class="p">),</span> <span class="n">customers_df</span><span class="o">.</span><span class="n">customer_id</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-----------+--------------+--------------+-----------+
|customer_id|customer_fname|customer_lname|order_count|
+-----------+--------------+--------------+-----------+
|        791|          Mary|         Smith|         15|
|       5047|       Shirley|     Whitehead|         14|
|       5477|          Mary|         Smith|         14|
|       6088|          Mary|        Brooks|         14|
|       9371|          Mary|     Patterson|         14|
|       3295|         Maria|        Joseph|         13|
|       3536|          Mary|        Tanner|         13|
|       4582|         Brian|         House|         13|
|       5865|         David|     Middleton|         13|
|       8069|       Tiffany|      Mcdaniel|         13|
+-----------+--------------+--------------+-----------+
only showing top 10 rows
</pre></div>
</div>
<p>​</p>
<p><a class="reference external" href="#Table-of-contents">Back to Top</a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">spark</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./retail-database-analysis-python"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="../cluster-uber-trip-data/cluster-uber-trip-data.html" title="previous page">Clustering Uber’s Trip Data with Apache Spark</a>
    <a class='right-next' id="next-link" href="../leetcode/lc5455.html" title="next page">5455. Minimum Number of Days to Make m Bouquets</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Anindya Saha<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    <script src="../_static/js/index.js"></script>
    
  </body>
</html>